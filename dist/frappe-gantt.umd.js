(function(v,x){typeof exports=="object"&&typeof module<"u"?module.exports=x():typeof define=="function"&&define.amd?define(x):(v=typeof globalThis<"u"?globalThis:v||self,v.Gantt=x())})(this,function(){"use strict";const v="year",x="month",S="day",H="hour",X="minute",F="second",U="millisecond",_={parse_duration(n){const e=/([0-9]+)(y|m|d|h|min|s|ms)/gm.exec(n);if(e!==null){if(e[2]==="y")return{duration:parseInt(e[1]),scale:"year"};if(e[2]==="m")return{duration:parseInt(e[1]),scale:"month"};if(e[2]==="d")return{duration:parseInt(e[1]),scale:"day"};if(e[2]==="h")return{duration:parseInt(e[1]),scale:"hour"};if(e[2]==="min")return{duration:parseInt(e[1]),scale:"minute"};if(e[2]==="s")return{duration:parseInt(e[1]),scale:"second"};if(e[2]==="ms")return{duration:parseInt(e[1]),scale:"millisecond"}}},parse(n,t="-",e=/[.:]/){if(n instanceof Date)return n;if(typeof n=="string"){let i,s;const a=n.split(" ");i=a[0].split(t).map(r=>parseInt(r,10)),s=a[1]&&a[1].split(e),i[1]=i[1]?i[1]-1:0;let o=i;return s&&s.length&&(s.length===4&&(s[3]="0."+s[3],s[3]=parseFloat(s[3])*1e3),o=o.concat(s)),new Date(...o)}},to_string(n,t=!1){if(!(n instanceof Date))throw new TypeError("Invalid argument type");const e=this.get_date_values(n).map((a,o)=>(o===1&&(a=a+1),o===6?E(a+"",3,"0"):E(a+"",2,"0"))),i=`${e[0]}-${e[1]}-${e[2]}`,s=`${e[3]}:${e[4]}:${e[5]}.${e[6]}`;return i+(t?" "+s:"")},format(n,t="YYYY-MM-DD HH:mm:ss.SSS",e="en"){const i=new Intl.DateTimeFormat(e,{month:"long"}),s=new Intl.DateTimeFormat(e,{month:"short"}),a=i.format(n),o=a.charAt(0).toUpperCase()+a.slice(1),r=this.get_date_values(n).map(c=>E(c,2,0)),h={YYYY:r[0],MM:E(+r[1]+1,2,0),DD:r[2],HH:r[3],mm:r[4],ss:r[5],SSS:r[6],D:r[2],MMMM:o,MMM:s.format(n)};let d=t;const l=[];return Object.keys(h).sort((c,p)=>p.length-c.length).forEach(c=>{d.includes(c)&&(d=d.replaceAll(c,`$${l.length}`),l.push(h[c]))}),l.forEach((c,p)=>{d=d.replaceAll(`$${p}`,c)}),d},diff(n,t,e="day"){let i,s,a,o,r,h,d;i=n-t+(t.getTimezoneOffset()-n.getTimezoneOffset())*6e4,s=i/1e3,o=s/60,a=o/60,r=a/24;let l=n.getFullYear()-t.getFullYear(),c=n.getMonth()-t.getMonth();return c+=r%30/30,h=l*12+c,n.getDate()<t.getDate()&&h--,d=h/12,e.endsWith("s")||(e+="s"),Math.round({milliseconds:i,seconds:s,minutes:o,hours:a,days:r,months:h,years:d}[e]*100)/100},today(){const n=this.get_date_values(new Date).slice(0,3);return new Date(...n)},now(){return new Date},add(n,t,e){t=parseInt(t,10);const i=[n.getFullYear()+(e===v?t:0),n.getMonth()+(e===x?t:0),n.getDate()+(e===S?t:0),n.getHours()+(e===H?t:0),n.getMinutes()+(e===X?t:0),n.getSeconds()+(e===F?t:0),n.getMilliseconds()+(e===U?t:0)];return new Date(...i)},start_of(n,t){const e={[v]:6,[x]:5,[S]:4,[H]:3,[X]:2,[F]:1,[U]:0};function i(a){const o=e[t];return e[a]<=o}const s=[n.getFullYear(),i(v)?0:n.getMonth(),i(x)?1:n.getDate(),i(S)?0:n.getHours(),i(H)?0:n.getMinutes(),i(X)?0:n.getSeconds(),i(F)?0:n.getMilliseconds()];return new Date(...s)},clone(n){return new Date(...this.get_date_values(n))},get_date_values(n){return[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()]},convert_scales(n,t){const e={millisecond:11574074074074074e-24,second:11574074074074073e-21,minute:.0006944444444444445,hour:.041666666666666664,day:1,month:30,year:365},{duration:i,scale:s}=this.parse_duration(n);return i*e[s]/e[t]},get_days_in_month(n){const t=[31,28,31,30,31,30,31,31,30,31,30,31],e=n.getMonth();if(e!==1)return t[e];const i=n.getFullYear();return i%4===0&&i%100!=0||i%400===0?29:28},get_days_in_year(n){return n.getFullYear()%4?365:366}};function E(n,t,e){return n=n+"",t=t>>0,e=String(typeof e<"u"?e:" "),n.length>t?String(n):(t=t-n.length,t>e.length&&(e+=e.repeat(t/e.length)),e.slice(0,t)+String(n))}function f(n,t){return typeof n=="string"?(t||document).querySelector(n):n||null}function w(n,t){const e=document.createElementNS("http://www.w3.org/2000/svg",n);for(let i in t)i==="append_to"?t.append_to.appendChild(e):i==="innerHTML"?e.innerHTML=t.innerHTML:i==="clipPath"?e.setAttribute("clip-path","url(#"+t[i]+")"):e.setAttribute(i,t[i]);return e}function I(n,t,e,i){const s=V(n,t,e,i);if(s===n){const a=document.createEvent("HTMLEvents");a.initEvent("click",!0,!0),a.eventName="click",s.dispatchEvent(a)}}function V(n,t,e,i,s="0.4s",a="0.1s"){const o=n.querySelector("animate");if(o)return f.attr(o,{attributeName:t,from:e,to:i,dur:s,begin:"click + "+a}),n;const r=w("animate",{attributeName:t,from:e,to:i,dur:s,begin:a,calcMode:"spline",values:e+";"+i,keyTimes:"0; 1",keySplines:W("ease-out")});return n.appendChild(r),n}function W(n){return{ease:".25 .1 .25 1",linear:"0 0 1 1","ease-in":".42 0 1 1","ease-out":"0 0 .58 1","ease-in-out":".42 0 .58 1"}[n]}f.on=(n,t,e,i)=>{i?f.delegate(n,t,e,i):(i=e,f.bind(n,t,i))},f.off=(n,t,e)=>{n.removeEventListener(t,e)},f.bind=(n,t,e)=>{t.split(/\s+/).forEach(function(i){n.addEventListener(i,e)})},f.delegate=(n,t,e,i)=>{n.addEventListener(t,function(s){const a=s.target.closest(e);a&&(s.delegatedTarget=a,i.call(this,s,a))})},f.closest=(n,t)=>t?t.matches(n)?t:f.closest(n,t.parentNode):null,f.attr=(n,t,e)=>{if(!e&&typeof t=="string")return n.getAttribute(t);if(typeof t=="object"){for(let i in t)f.attr(n,i,t[i]);return}n.setAttribute(t,e)};class N{constructor(t,e,i){this.gantt=t,this.from_task=e,this.to_task=i,this.calculate_path(),this.draw()}calculate_path(){let t=this.from_task.$bar.getX()+this.from_task.$bar.getWidth()/2;const e=()=>this.to_task.$bar.getX()<t+this.gantt.options.padding&&t>this.from_task.$bar.getX()+this.gantt.options.padding;for(;e();)t-=10;t-=10;let i=this.gantt.config.header_height+this.gantt.options.bar_height+(this.gantt.options.padding+this.gantt.options.bar_height)*this.from_task.task._index+this.gantt.options.padding/2,s=this.to_task.$bar.getX()-13,a=this.gantt.config.header_height+this.gantt.options.bar_height/2+(this.gantt.options.padding+this.gantt.options.bar_height)*this.to_task.task._index+this.gantt.options.padding/2;const o=this.from_task.task._index>this.to_task.task._index;let r=this.gantt.options.arrow_curve;const h=o?1:0;let d=o?-r:r;if(this.to_task.$bar.getX()<=this.from_task.$bar.getX()+this.gantt.options.padding){let l=this.gantt.options.padding/2-r;l<0&&(l=0,r=this.gantt.options.padding/2,d=o?-r:r);const c=this.to_task.$bar.getY()+this.to_task.$bar.getHeight()/2-d,p=this.to_task.$bar.getX()-this.gantt.options.padding;this.path=`
                M ${t} ${i}
                v ${l}
                a ${r} ${r} 0 0 1 ${-r} ${r}
                H ${p}
                a ${r} ${r} 0 0 ${h} ${-r} ${d}
                V ${c}
                a ${r} ${r} 0 0 ${h} ${r} ${d}
                L ${s} ${a}
                m -5 -5
                l 5 5
                l -5 5`}else{s<t+r&&(r=s-t);let l=o?a+r:a-r;this.path=`
              M ${t} ${i}
              V ${l}
              a ${r} ${r} 0 0 ${h} ${r} ${r}
              L ${s} ${a}
              m -5 -5
              l 5 5
              l -5 5`}}draw(){this.element=w("path",{d:this.path,"data-from":this.from_task.task.id,"data-to":this.to_task.task.id})}update(){this.calculate_path(),this.element.setAttribute("d",this.path)}}class Q{constructor(t,e){this.set_defaults(t,e),this.prepare_wrappers(),this.prepare_helpers(),this.refresh()}refresh(){this.bar_group.innerHTML="",this.handle_group.innerHTML="",this.task.custom_class?this.group.classList.add(this.task.custom_class):this.group.classList=["bar-wrapper"],this.prepare_values(),this.draw(),this.bind()}set_defaults(t,e){this.action_completed=!1,this.gantt=t,this.task=e,this.name=this.name||""}prepare_wrappers(){this.group=w("g",{class:"bar-wrapper"+(this.task.custom_class?" "+this.task.custom_class:""),"data-id":this.task.id}),this.bar_group=w("g",{class:"bar-group",append_to:this.group}),this.handle_group=w("g",{class:"handle-group",append_to:this.group})}prepare_values(){this.invalid=this.task.invalid,this.height=this.gantt.options.bar_height,this.image_size=this.height-5,this.task._start=new Date(this.task.start),this.task._end=new Date(this.task.end),this.compute_x(),this.compute_y(),this.compute_duration(),this.corner_radius=this.gantt.options.bar_corner_radius,this.width=this.gantt.config.column_width*this.duration,(!this.task.progress||this.task.progress<0)&&(this.task.progress=0),this.task.progress>100&&(this.task.progress=100)}prepare_helpers(){SVGElement.prototype.getX=function(){return+this.getAttribute("x")},SVGElement.prototype.getY=function(){return+this.getAttribute("y")},SVGElement.prototype.getWidth=function(){return+this.getAttribute("width")},SVGElement.prototype.getHeight=function(){return+this.getAttribute("height")},SVGElement.prototype.getEndX=function(){return this.getX()+this.getWidth()}}prepare_expected_progress_values(){this.compute_expected_progress(),this.expected_progress_width=this.gantt.options.column_width*this.duration*(this.expected_progress/100)||0}draw(){this.draw_bar(),this.draw_progress_bar(),this.gantt.options.show_expected_progress&&(this.prepare_expected_progress_values(),this.draw_expected_progress_bar()),this.draw_label(),this.draw_resize_handles(),this.task.thumbnail&&this.draw_thumbnail()}draw_bar(){this.$bar=w("rect",{x:this.x,y:this.y,width:this.width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar",append_to:this.bar_group}),this.task.color&&(this.$bar.style.fill=this.task.color),I(this.$bar,"width",0,this.width),this.invalid&&this.$bar.classList.add("bar-invalid")}draw_expected_progress_bar(){this.invalid||(this.$expected_bar_progress=w("rect",{x:this.x,y:this.y,width:this.expected_progress_width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar-expected-progress",append_to:this.bar_group}),I(this.$expected_bar_progress,"width",0,this.expected_progress_width))}draw_progress_bar(){if(this.invalid)return;this.progress_width=this.calculate_progress_width();let t=this.corner_radius;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(t=this.corner_radius+2),this.$bar_progress=w("rect",{x:this.x,y:this.y,width:this.progress_width,height:this.height,rx:t,ry:t,class:"bar-progress",append_to:this.bar_group}),this.task.color_progress&&(this.$bar_progress.style.fill=this.task.color_progress);const e=_.diff(this.task._start,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let i=this.gantt.create_el({classes:`date-range-highlight hide highlight-${this.task.id}`,width:this.width,left:e});this.$date_highlight=i,this.gantt.$lower_header.prepend(this.$date_highlight),I(this.$bar_progress,"width",0,this.progress_width)}calculate_progress_width(){const t=this.$bar.getWidth(),e=this.x+t,i=this.gantt.config.ignored_positions.reduce((h,d)=>h+(d>=this.x&&d<e),0)*this.gantt.config.column_width;let s=(t-i)*this.task.progress/100;const a=this.x+s,o=this.gantt.config.ignored_positions.reduce((h,d)=>h+(d>=this.x&&d<a),0)*this.gantt.config.column_width;s+=o;let r=this.gantt.get_ignored_region(this.x+s);for(;r.length;)s+=this.gantt.config.column_width,r=this.gantt.get_ignored_region(this.x+s);return this.progress_width=s,s}draw_label(){let t=this.x+this.$bar.getWidth()/2;this.task.thumbnail&&(t=this.x+this.image_size+5),w("text",{x:t,y:this.y+this.height/2,innerHTML:this.task.name,class:"bar-label",append_to:this.bar_group}),requestAnimationFrame(()=>this.update_label_position())}draw_thumbnail(){let t=10,e=2,i,s;i=w("defs",{append_to:this.bar_group}),w("rect",{id:"rect_"+this.task.id,x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,rx:"15",class:"img_mask",append_to:i}),s=w("clipPath",{id:"clip_"+this.task.id,append_to:i}),w("use",{href:"#rect_"+this.task.id,append_to:s}),w("image",{x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,class:"bar-img",href:this.task.thumbnail,clipPath:"clip_"+this.task.id,append_to:this.bar_group})}draw_resize_handles(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar,e=3;if(this.handles=[],this.gantt.options.readonly_dates||(this.handles.push(w("rect",{x:t.getEndX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle right",append_to:this.handle_group})),this.handles.push(w("rect",{x:t.getX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle left",append_to:this.handle_group}))),!this.gantt.options.readonly_progress){const i=this.$bar_progress;this.$handle_progress=w("circle",{cx:i.getEndX(),cy:i.getY()+i.getHeight()/2,r:4.5,class:"handle progress",append_to:this.handle_group}),this.handles.push(this.$handle_progress)}for(let i of this.handles)f.on(i,"mouseenter",()=>i.classList.add("active")),f.on(i,"mouseleave",()=>i.classList.remove("active"))}bind(){this.invalid||this.setup_click_event()}setup_click_event(){let t=this.task.id;f.on(this.group,"mouseover",s=>{this.gantt.trigger_event("hover",[this.task,s.screenX,s.screenY,s])}),this.gantt.options.popup_on==="click"&&f.on(this.group,"mouseup",s=>{const a=s.offsetX||s.layerX;if(this.$handle_progress){const o=+this.$handle_progress.getAttribute("cx");if(o>a-1&&o<a+1||this.gantt.bar_being_dragged)return}this.gantt.show_popup({x:s.offsetX||s.layerX,y:s.offsetY||s.layerY,task:this.task,target:this.$bar})});let e;f.on(this.group,"mouseenter",s=>{e=setTimeout(()=>{this.gantt.options.popup_on==="hover"&&this.gantt.show_popup({x:s.offsetX||s.layerX,y:s.offsetY||s.layerY,task:this.task,target:this.$bar}),this.gantt.$container.querySelector(`.highlight-${t}`).classList.remove("hide")},200)}),f.on(this.group,"mouseleave",()=>{var s,a;clearTimeout(e),this.gantt.options.popup_on==="hover"&&((a=(s=this.gantt.popup)==null?void 0:s.hide)==null||a.call(s)),this.gantt.$container.querySelector(`.highlight-${t}`).classList.add("hide")}),f.on(this.group,"click",()=>{this.gantt.trigger_event("click",[this.task])}),f.on(this.group,"dblclick",s=>{this.action_completed||(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))});let i=!1;f.on(this.group,"touchstart",s=>{if(!i)return i=!0,setTimeout(function(){i=!1},300),!1;s.preventDefault(),!this.action_completed&&(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))})}update_bar_position({x:t=null,width:e=null}){const i=this.$bar;if(t){if(!this.task.dependencies.map(o=>this.gantt.get_bar(o).$bar.getX()).reduce((o,r)=>o&&t>=r,!0))return;this.update_attr(i,"x",t),this.x=t,this.$date_highlight.style.left=t+"px"}e>0&&(this.update_attr(i,"width",e),this.$date_highlight.style.width=e+"px"),this.update_label_position(),this.update_handle_position(),this.date_changed(),this.compute_duration(),this.gantt.options.show_expected_progress&&this.update_expected_progressbar_position(),this.update_progressbar_position(),this.update_arrow_position()}update_label_position_on_horizontal_scroll({x:t,sx:e}){const i=this.gantt.$container.querySelector(".gantt-container"),s=this.group.querySelector(".bar-label"),a=this.group.querySelector(".bar-img")||"",o=this.bar_group.querySelector(".img_mask")||"";let r=this.$bar.getX()+this.$bar.getWidth(),h=s.getX()+t,d=a&&a.getX()+t||0,l=a&&a.getBBox().width+7||7,c=h+s.getBBox().width+7,p=e+i.clientWidth/2;s.classList.contains("big")||(c<r&&t>0&&c<p||h-l>this.$bar.getX()&&t<0&&c>p)&&(s.setAttribute("x",h),a&&(a.setAttribute("x",d),o.setAttribute("x",d)))}date_changed(){let t=!1;const{new_start_date:e,new_end_date:i}=this.compute_start_end_date();Number(this.task._start)!==Number(e)&&(t=!0,this.task._start=e),Number(this.task._end)!==Number(i)&&(t=!0,this.task._end=i),t&&this.gantt.trigger_event("date_change",[this.task,e,_.add(i,-1,"second")])}progress_changed(){this.task.progress=this.compute_progress(),this.gantt.trigger_event("progress_change",[this.task,this.task.progress])}set_action_completed(){this.action_completed=!0,setTimeout(()=>this.action_completed=!1,1e3)}compute_start_end_date(){const t=this.$bar,e=t.getX()/this.gantt.config.column_width;let i=_.add(this.gantt.gantt_start,e*this.gantt.config.step,this.gantt.config.unit);const s=t.getWidth()/this.gantt.config.column_width,a=_.add(i,s*this.gantt.config.step,this.gantt.config.unit);return{new_start_date:i,new_end_date:a}}compute_progress(){this.progress_width=this.$bar_progress.getWidth(),this.x=this.$bar_progress.getBBox().x;const t=this.x+this.progress_width,e=this.progress_width-this.gantt.config.ignored_positions.reduce((s,a)=>s+(a>=this.x&&a<=t),0)*this.gantt.config.column_width;if(e<0)return 0;const i=this.$bar.getWidth()-this.ignored_duration_raw*this.gantt.config.column_width;return parseInt(e/i*100,10)}compute_expected_progress(){this.expected_progress=_.diff(_.today(),this.task._start,"hour")/this.gantt.config.step,this.expected_progress=(this.expected_progress<this.duration?this.expected_progress:this.duration)*100/this.duration}compute_x(){const{column_width:t}=this.gantt.config,e=this.task._start,i=this.gantt.gantt_start;let a=_.diff(e,i,this.gantt.config.unit)/this.gantt.config.step*t;this.x=a}compute_y(){this.y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding)}compute_duration(){let t=0,e=0;for(let i=new Date(this.task._start);i<this.task._end;i.setDate(i.getDate()+1))e++,!this.gantt.config.ignored_dates.find(s=>s.getTime()===i.getTime())&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(i))&&t++;this.task.actual_duration=t,this.task.ignored_duration=e-t,this.duration=_.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_duration_raw=_.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_duration_raw=this.duration-this.actual_duration_raw}update_attr(t,e,i){return i=+i,isNaN(i)||t.setAttribute(e,i),t}update_expected_progressbar_position(){this.invalid||(this.$expected_bar_progress.setAttribute("x",this.$bar.getX()),this.compute_expected_progress(),this.$expected_bar_progress.setAttribute("width",this.gantt.config.column_width*this.actual_duration_raw*(this.expected_progress/100)||0))}update_progressbar_position(){this.invalid||this.gantt.options.readonly||(this.$bar_progress.setAttribute("x",this.$bar.getX()),this.$bar_progress.setAttribute("width",this.calculate_progress_width()))}update_label_position(){const t=this.bar_group.querySelector(".img_mask")||"",e=this.$bar,i=this.group.querySelector(".bar-label"),s=this.group.querySelector(".bar-img");let a=5,o=this.image_size+10;const r=i.getBBox().width,h=e.getWidth();r>h?(i.classList.add("big"),s?(s.setAttribute("x",e.getEndX()+a),t.setAttribute("x",e.getEndX()+a),i.setAttribute("x",e.getEndX()+o)):i.setAttribute("x",e.getEndX()+a)):(i.classList.remove("big"),s?(s.setAttribute("x",e.getX()+a),t.setAttribute("x",e.getX()+a),i.setAttribute("x",e.getX()+h/2+o)):i.setAttribute("x",e.getX()+h/2-r/2))}update_handle_position(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar;this.handle_group.querySelector(".handle.left").setAttribute("x",t.getX()),this.handle_group.querySelector(".handle.right").setAttribute("x",t.getEndX());const e=this.group.querySelector(".handle.progress");e&&e.setAttribute("cx",this.$bar_progress.getEndX())}update_arrow_position(){this.arrows=this.arrows||[];for(let t of this.arrows)t.update()}}class j{constructor(t,e,i){this.parent=t,this.popup_func=e,this.gantt=i,this.make()}make(){this.parent.innerHTML=`
            <div class="title"></div>
            <div class="subtitle"></div>
            <div class="details"></div>
            <div class="actions"></div>
        `,this.hide(),this.title=this.parent.querySelector(".title"),this.subtitle=this.parent.querySelector(".subtitle"),this.details=this.parent.querySelector(".details"),this.actions=this.parent.querySelector(".actions")}show({x:t,y:e,task:i,target:s}){this.actions.innerHTML="";let a=this.popup_func({task:i,chart:this.gantt,get_title:()=>this.title,set_title:o=>this.title.innerHTML=o,get_subtitle:()=>this.subtitle,set_subtitle:o=>this.subtitle.innerHTML=o,get_details:()=>this.details,set_details:o=>this.details.innerHTML=o,add_action:(o,r)=>{let h=this.gantt.create_el({classes:"action-btn",type:"button",append_to:this.actions});typeof o=="function"&&(o=o(i)),h.innerHTML=o,h.onclick=d=>r(i,this.gantt,d)}});a!==!1&&(a&&(this.parent.innerHTML=a),this.actions.innerHTML===""?this.actions.remove():this.parent.appendChild(this.actions),this.parent.style.left=t+10+"px",this.parent.style.top=e-10+"px",this.parent.classList.remove("hide"))}hide(){this.parent.classList.add("hide")}}function C(n){const t=n.getFullYear();return t-t%10+""}function z(n,t,e){let i=_.add(n,6,"day"),s=i.getMonth()!==n.getMonth()?"D MMM":"D",a=!t||n.getMonth()!==t.getMonth()?"D MMM":"D";return`${_.format(n,a,e)} - ${_.format(i,s,e)}`}const $=[{name:"Hour",padding:"7d",step:"1h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?_.format(n,"D MMMM",e):"",upper_text_frequency:24},{name:"Quarter Day",padding:"7d",step:"6h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?_.format(n,"D MMM",e):"",upper_text_frequency:4},{name:"Half Day",padding:"14d",step:"12h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?n.getMonth()!==n.getMonth()?_.format(n,"D MMM",e):_.format(n,"D",e):"",upper_text_frequency:2},{name:"Day",padding:"7d",date_format:"YYYY-MM-DD",step:"1d",lower_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?_.format(n,"D",e):"",upper_text:(n,t,e)=>!t||n.getMonth()!==t.getMonth()?_.format(n,"MMMM",e):"",thick_line:n=>n.getDay()===1},{name:"Week",padding:"1m",step:"7d",date_format:"YYYY-MM-DD",column_width:140,lower_text:z,upper_text:(n,t,e)=>!t||n.getMonth()!==t.getMonth()?_.format(n,"MMMM",e):"",thick_line:n=>n.getDate()>=1&&n.getDate()<=7,upper_text_frequency:4},{name:"Month",padding:"2m",step:"1m",column_width:120,date_format:"YYYY-MM",lower_text:"MMMM",upper_text:(n,t,e)=>!t||n.getFullYear()!==t.getFullYear()?_.format(n,"YYYY",e):"",thick_line:n=>n.getMonth()%3===0,snap_at:"7d"},{name:"Year",padding:"2y",step:"1y",column_width:120,date_format:"YYYY",upper_text:(n,t,e)=>!t||C(n)!==C(t)?C(n):"",lower_text:"YYYY",snap_at:"30d"}],O={arrow_curve:5,auto_move_label:!1,bar_corner_radius:3,bar_height:30,container_height:"auto",column_width:null,date_format:"YYYY-MM-DD HH:mm",upper_header_height:45,lower_header_height:30,snap_at:null,infinite_padding:!0,holidays:{"var(--g-weekend-highlight-color)":"weekend"},ignore:[],language:"en",lines:"both",move_dependencies:!0,padding:18,popup:n=>{n.set_title(n.task.name),n.task.description?n.set_subtitle(n.task.description):n.set_subtitle("");const t=_.format(n.task._start,"MMM D",n.chart.options.language),e=_.format(_.add(n.task._end,-1,"second"),"MMM D",n.chart.options.language);n.set_details(`${t} - ${e} (${n.task.actual_duration} days${n.task.ignored_duration?" + "+n.task.ignored_duration+" excluded":""})<br/>Progress: ${Math.floor(n.task.progress*100)/100}%`)},popup_on:"click",readonly_progress:!1,readonly_dates:!1,readonly:!1,scroll_to:"custom",show_expected_progress:!1,today_button:!0,view_mode:"Day",view_mode_select:!1,view_modes:$,custom_marker:!0,custom_marker_init_date:"2025-04-08T00:00:00Z",player_end_date:"2025-04-17T00:00:00Z",player_button:!0,player_interval:1e3,player_loop:!0,player_use_fa:!0};class q{constructor(t,e,i){this.setup_wrapper(t),this.setup_options(i),this.setup_tasks(e),this.overlapping_tasks=new Set,this.lastTaskY=null,this.change_view_mode(),this.bind_events(),this.scrollAnimationFrame=null,this.taskInterval=null,this.viewerUpdateQueue=new Map,this.lastViewerUpdate=0,this.eventQueue=new Map,this.lastEventUpdate=0,this.shadingNodeCache=new Map}setup_wrapper(t){let e,i;if(typeof t=="string"){let s=document.querySelector(t);if(!s)throw new ReferenceError(`CSS selector "${t}" could not be found in DOM`);t=s}if(t instanceof HTMLElement)i=t,e=t.querySelector("svg");else if(t instanceof SVGElement)e=t;else throw new TypeError("Frappe Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");e?(this.$svg=e,this.$svg.classList.add("gantt")):this.$svg=w("svg",{append_to:i,class:"gantt"}),this.$container=this.create_el({classes:"gantt-container",append_to:this.$svg.parentElement}),this.$container.appendChild(this.$svg),this.$popup_wrapper=this.create_el({classes:"popup-wrapper",append_to:this.$container})}setup_options(t){var o;this.original_options=t,this.options={...O,...t,task_interval:t.task_interval||30,viewer_debounce_interval:t.viewer_debounce_interval||100,event_debounce_interval:t.event_debounce_interval||20};const e={"grid-height":"container_height","bar-height":"bar_height","lower-header-height":"lower_header_height","upper-header-height":"upper_header_height"};for(let r in e){let h=this.options[e[r]];h!=="auto"&&this.$container.style.setProperty("--gv-"+r,h+"px")}this.config={ignored_dates:[],ignored_positions:[],extend_by_units:5},this.options.player_button&&(this.options.player_state=!1);const i=this.options.view_mode||"Day";let s,a=-2;switch(i.toLowerCase()){case"hour":s="hour";break;case"quarter_day":s="hour",a=-2*6;break;case"half_day":s="hour",a=-2*12;break;case"day":s="day";break;case"week":s="week";break;case"month":s="month";break;case"year":s="year";break;default:s="day"}if(this.options.custom_marker){const r=this.options.custom_marker_init_date?new Date(this.options.custom_marker_init_date):new Date(((o=this.tasks[0])==null?void 0:o._start)||Date.now());let h=new Date(r);s==="week"?h.setDate(r.getDate()+a*7):s==="month"?h.setMonth(r.getMonth()+a):s==="year"?h.setFullYear(r.getFullYear()+a):h=_.add(r,a,s),this.config.custom_marker_date=h,console.log(`setup_options: view_mode=${i}, baseDate=${r}, offset=${a} ${s}, custom_marker_date=${this.config.custom_marker_date}`)}if(this.options.player_end_date&&(this.config.player_end_date=new Date(this.options.player_end_date),console.log(`setup_options: Set player_end_date=${this.config.player_end_date}`)),typeof this.options.ignore!="function"){typeof this.options.ignore=="string"&&(this.options.ignore=[this.options.ignore]);for(let r of this.options.ignore){if(typeof r=="function"){this.config.ignored_function=r;continue}typeof r=="string"&&(r==="weekend"?this.config.ignored_function=h=>h.getDay()==6||h.getDay()==0:this.config.ignored_dates.push(new Date(r+" ")))}}else this.config.ignored_function=this.options.ignore}setup_tasks(t){var e;if(!t||!Array.isArray(t)){console.error("setup_tasks: Invalid tasks input, expected array:",t),this.tasks=[];return}this.tasks=t.map((i,s)=>{if(i._start=_.parse(i.start),i._end=_.parse(i.end),!i.start&&!i.end){const a=new Date;i._start=a,i._end=_.add(a,1,"day")}return!i.end&&i.start&&(i._end=_.add(i._start,i.duration||1,"day")),i._index=s,i.id||(i.id=P(i)),i.name||(i.name=i.id),i.progress=parseFloat(i.progress)||0,(isNaN(i._start.getTime())||isNaN(i._end.getTime()))&&(console.warn(`Invalid task dates: id=${i.id}, start=${i.start}, end=${i.end}`),i._start=new Date,i._end=_.add(i._start,1,"day")),console.log(`setup_tasks: Task id=${i.id}, name=${i.name}, start=${i._start}, end=${i._end}`),i}),(e=this.options.phasing_config)!=null&&e.objects?console.log("setup_tasks: phasing_config.objects:",this.options.phasing_config.objects):console.warn("setup_tasks: phasing_config.objects is empty or undefined")}setup_dependencies(){this.dependency_map={};for(let t of this.tasks)for(let e of t.dependencies)this.dependency_map[e]=this.dependency_map[e]||[],this.dependency_map[e].push(t.id)}refresh(t){this.setup_tasks(t),this.change_view_mode(),this.scroll_to_latest_task()}update_task(t,e){let i=this.tasks.find(a=>a.id===t),s=this.bars[i._index];Object.assign(i,e),s.refresh()}change_view_mode(t=this.options.view_mode,e=!1){typeof t=="string"&&(t=this.options.view_modes.find(a=>a.name===t));let i,s;e&&(i=this.$container.scrollLeft,s=this.options.scroll_to,this.options.scroll_to=null),this.options.view_mode=t.name,this.config.view_mode=t,this.update_view_scale(t),this.setup_dates(e),this.render(),e&&(this.$container.scrollLeft=i,this.options.scroll_to=s),this.trigger_event("view_change",[t])}update_view_scale(t){let{duration:e,scale:i}=_.parse_duration(t.step);this.config.step=e,this.config.unit=i,this.config.column_width=this.options.column_width||t.column_width||45,this.$container.style.setProperty("--gv-column-width",this.config.column_width+"px"),this.config.header_height=this.options.lower_header_height+this.options.upper_header_height+10}setup_dates(t=!1){this.setup_gantt_dates(t),this.setup_date_values()}setup_gantt_dates(){this.gantt_start=this.gantt_end=null;for(let a of this.tasks)(!this.gantt_start||a._start<this.gantt_start)&&(this.gantt_start=a._start),(!this.gantt_end||a._end>this.gantt_end)&&(this.gantt_end=a._end);if(!this.gantt_start||!this.gantt_end){console.warn("setup_gantt_dates: No valid tasks, setting default dates");const a=new Date;this.gantt_start=a,this.gantt_end=_.add(a,1,"day")}console.log(`setup_gantt_dates: Initial gantt_start=${this.gantt_start}, gantt_end=${this.gantt_end}`),this.config.custom_marker_date&&this.config.custom_marker_date<this.gantt_start&&(this.gantt_start=_.start_of(this.config.custom_marker_date,this.config.unit),console.log(`setup_gantt_dates: Adjusted gantt_start to ${this.gantt_start} to include run-up`)),this.gantt_start=_.start_of(this.gantt_start,this.config.unit),console.log(`setup_gantt_dates: Aligned gantt_start=${this.gantt_start}`),this.gantt_end=_.start_of(this.gantt_end,this.config.unit),console.log(`setup_gantt_dates: Aligned gantt_end=${this.gantt_end}`);const t=this.options.view_mode||"Day";let e,i=2;switch(t.toLowerCase()){case"hour":e="hour";break;case"quarter_day":e="hour",i=2*6;break;case"half_day":e="hour",i=2*12;break;case"day":e="day";break;case"week":e="week";break;case"month":e="month";break;case"year":e="year";break;default:e="day"}e!==this.config.unit&&console.warn(`setup_gantt_dates: offsetUnit=${e} differs from config.unit=${this.config.unit}`);let s=new Date(this.gantt_end);e==="week"?s.setDate(this.gantt_end.getDate()+i*7):e==="month"?s.setMonth(this.gantt_end.getMonth()+i):e==="year"?s.setFullYear(this.gantt_end.getFullYear()+i):s=_.add(this.gantt_end,i,e),this.gantt_end=_.start_of(s,this.config.unit),console.log(`setup_gantt_dates: Applied ${i} ${e} offset to gantt_end=${this.gantt_end}`),this.gantt_start=_.add(this.gantt_start,-5,this.config.unit),this.gantt_end=_.add(this.gantt_end,5,this.config.unit),console.log(`setup_gantt_dates: Final gantt_start=${this.gantt_start}, gantt_end=${this.gantt_end}`)}setup_date_values(){let t=this.gantt_start;for(this.dates=[t];t<this.gantt_end;)t=_.add(t,this.config.step,this.config.unit),this.dates.push(t)}bind_events(){this.bind_grid_click(),this.bind_holiday_labels(),this.bind_bar_events()}render(){try{if(!this.gantt_start||!this.gantt_end){console.error("Invalid gantt_start or gantt_end",{gantt_start:this.gantt_start,gantt_end:this.gantt_end});return}if(this.config.custom_marker_date||(this.config.custom_marker_date=new Date(this.options.custom_marker_init_date||this.gantt_start)),(this.config.custom_marker_date<this.gantt_start||this.config.custom_marker_date>this.gantt_end)&&(this.config.custom_marker_date=new Date(this.gantt_start)),this.clear(),this.setup_layers(),this.make_grid(),this.make_dates(),this.make_grid_extras(),this.make_bars(),this.make_arrows(),this.map_arrows_on_bars(),this.set_dimensions(),this.set_scroll_position(this.options.scroll_to),this.options.custom_marker){const e=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.play_animated_highlight(e,this.config.custom_marker_date)}}catch(t){console.error("Error during render:",t)}}setup_layers(){this.layers={};const t=["grid","arrow","progress","bar"];for(let e of t)this.layers[e]=w("g",{class:e,append_to:this.$svg});this.$extras=this.create_el({classes:"extras",append_to:this.$container}),this.$adjust=this.create_el({classes:"adjust hide",append_to:this.$extras,type:"button"}),this.$adjust.innerHTML="←"}make_grid(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_side_header()}make_grid_extras(){this.make_grid_highlights(),this.make_grid_ticks()}make_grid_background(){const t=this.dates.length*this.config.column_width,e=Math.max(this.config.header_height+this.options.padding+(this.options.bar_height+this.options.padding)*this.tasks.length-10,this.options.container_height!=="auto"?this.options.container_height:0);w("rect",{x:0,y:0,width:t,height:e,class:"grid-background",append_to:this.$svg}),f.attr(this.$svg,{height:e,width:"100%"}),this.grid_height=e,this.options.container_height==="auto"&&(this.$container.style.height=e+16+"px")}make_grid_rows(){const t=w("g",{append_to:this.layers.grid}),e=this.dates.length*this.config.column_width,i=this.options.bar_height+this.options.padding;this.config.header_height;for(let s=this.config.header_height;s<this.grid_height;s+=i)w("rect",{x:0,y:s,width:e,height:i,class:"grid-row",append_to:t})}make_grid_header(){this.$header=this.create_el({width:this.dates.length*this.config.column_width,classes:"grid-header",append_to:this.$container}),this.$upper_header=this.create_el({classes:"upper-header",append_to:this.$header}),this.$lower_header=this.create_el({classes:"lower-header",append_to:this.$header})}make_side_header(){if(this.$side_header=this.create_el({classes:"side-header"}),this.$upper_header.prepend(this.$side_header),this.options.view_mode_select){const t=document.createElement("select");t.classList.add("viewmode-select");const e=document.createElement("option");e.selected=!0,e.disabled=!0,e.textContent="Mode",t.appendChild(e);for(const i of this.options.view_modes){const s=document.createElement("option");s.value=i.name,s.textContent=i.name,i.name===this.config.view_mode.name&&(s.selected=!0),t.appendChild(s)}t.addEventListener("change",(function(){this.change_view_mode(t.value,!0)}).bind(this)),this.$side_header.appendChild(t)}if(this.options.today_button){let t=document.createElement("button");t.classList.add("today-button"),t.textContent="Today",t.onclick=this.scroll_current.bind(this),this.$side_header.prepend(t),this.$today_button=t}if(this.options.player_button){let t=document.createElement("button");t.classList.add("player-reset-button"),this.options.player_use_fa?t.classList.add("fas","fa-redo"):t.textContent="Reset",t.onclick=this.reset_play.bind(this),this.$side_header.prepend(t),this.$player_reset_button=t}if(this.options.player_button){let t=document.createElement("button");t.classList.add("player-button"),this.options.player_use_fa?(t.classList.add("fas"),this.options.player_state?t.classList.add("fa-pause"):t.classList.add("fa-play")):t.textContent="Play",t.onclick=this.toggle_play.bind(this),this.$side_header.prepend(t),this.$player_button=t}}make_grid_ticks(){if(this.options.lines==="none")return;let t=0,e=this.config.header_height,i=this.grid_height-this.config.header_height,s=w("g",{class:"lines_layer",append_to:this.layers.grid}),a=this.config.header_height;const o=this.dates.length*this.config.column_width,r=this.options.bar_height+this.options.padding;if(this.options.lines!=="vertical")for(let h=this.config.header_height;h<this.grid_height;h+=r)w("line",{x1:0,y1:a+r,x2:o,y2:a+r,class:"row-line",append_to:s}),a+=r;if(this.options.lines!=="horizontal")for(let h of this.dates){let d="tick";this.config.view_mode.thick_line&&this.config.view_mode.thick_line(h)&&(d+=" thick"),w("path",{d:`M ${t} ${e} v ${i}`,class:d,append_to:this.layers.grid}),this.view_is("month")?t+=_.get_days_in_month(h)*this.config.column_width/30:this.view_is("year")?t+=_.get_days_in_year(h)*this.config.column_width/365:t+=this.config.column_width}}highlight_holidays(){let t={};if(this.options.holidays)for(let e in this.options.holidays){let i=this.options.holidays[e];i==="weekend"&&(i=a=>a.getDay()===0||a.getDay()===6);let s;if(typeof i=="object"){let a=i.find(o=>typeof o=="function");if(a&&(s=a),this.options.holidays.name){let o=new Date(i.date+" ");i=r=>o.getTime()===r.getTime(),t[o]=i.name}else i=o=>this.options.holidays[e].filter(r=>typeof r!="function").map(r=>{if(r.name){let h=new Date(r.date+" ");return t[h]=r.name,h.getTime()}return new Date(r+" ").getTime()}).includes(o.getTime())}for(let a=new Date(this.gantt_start);a<=this.gantt_end;a.setDate(a.getDate()+1))if(!(this.config.ignored_dates.find(o=>o.getTime()==a.getTime())||this.config.ignored_function&&this.config.ignored_function(a))&&(i(a)||s&&s(a))){const o=_.diff(a,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width,r=this.grid_height-this.config.header_height,h=_.format(a,"YYYY-MM-DD",this.options.language).replace(" ","_");if(t[a]){let d=this.create_el({classes:"holiday-label label_"+h,append_to:this.$extras});d.textContent=t[a]}w("rect",{x:Math.round(o),y:this.config.header_height,width:this.config.column_width/_.convert_scales(this.config.view_mode.step,"day"),height:r,class:"holiday-highlight "+h,style:`fill: ${e};`,append_to:this.layers.grid})}}}highlight_current(){const t=document.querySelector(".grid-row .today-highlight");t&&t.classList.remove("today-highlight");const e=this.config.custom_marker_date||new Date;let i;switch(this.options.view_mode.toLowerCase()){case"year":i=_.format(e,"YYYY");break;case"month":i=_.format(e,"YYYY-MM");break;case"week":const a=_.start_of(e,"week");i=_.format(a,"YYYY-MM-DD");break;default:i=_.format(e,"YYYY-MM-DD")}const s=document.querySelector(`.grid-row [data-date="${i}"]`);s?s.classList.add("today-highlight"):console.warn(`highlight_current: No cell found for date=${i}`)}highlight_custom(t){return console.warn("highlight_custom is deprecated; using animated-highlight instead"),this.play_animated_highlight(0,t)}make_grid_highlights(){this.highlight_holidays(),this.config.ignored_positions=[];const t=(this.options.bar_height+this.options.padding)*this.tasks.length;this.layers.grid.innerHTML+=`<pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
          <path d="M-1,1 l2,-2
                   M0,4 l4,-4
                   M3,5 l2,-2"
                style="stroke:grey; stroke-width:0.3" />
        </pattern>`;for(let e=new Date(this.gantt_start);e<=this.gantt_end;e.setDate(e.getDate()+1)){if(!this.config.ignored_dates.find(s=>s.getTime()==e.getTime())&&(!this.config.ignored_function||!this.config.ignored_function(e)))continue;let i=_.convert_scales(_.diff(e,this.gantt_start)+"d",this.config.unit)/this.config.step;this.config.ignored_positions.push(i*this.config.column_width),w("rect",{x:i*this.config.column_width,y:this.config.header_height,width:this.config.column_width,height:t,class:"ignored-bar",style:"fill: url(#diagonalHatch);",append_to:this.$svg})}if(this.highlight_current(),this.options.custom_marker){(!this.config.custom_marker_date||isNaN(this.config.custom_marker_date))&&(this.config.custom_marker_date=new Date(this.options.custom_marker_init_date||this.gantt_start)),(this.config.custom_marker_date<this.gantt_start||this.config.custom_marker_date>this.gantt_end)&&(this.config.custom_marker_date=new Date(this.gantt_start));const i=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.play_animated_highlight(i,this.config.custom_marker_date)}}play_animated_highlight(t,e){let i=t,s=e;(!e||isNaN(t)||t===0)&&(s=this.config.custom_marker_date||new Date(this.gantt_start),i=_.diff(s,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width);let a=this.grid_height||1152;const o=this.$svg.querySelector(".grid-background");if(o?a=parseFloat(o.getAttribute("height"))||a:console.warn("Grid element not found, using default height:",a),this.$animated_highlight?(this.$animated_highlight.style.left=`${i}px`,this.$animated_highlight.style.height=`${a-this.config.header_height}px`):this.$animated_highlight=this.create_el({top:this.config.header_height,left:i,width:2,height:a-this.config.header_height,classes:"animated-highlight",append_to:this.$container,style:"background: var(--g-custom-highlight); z-index: 999;"}),this.$animated_ball_highlight?this.$animated_ball_highlight.style.left=`${i-2}px`:this.$animated_ball_highlight=this.create_el({top:this.config.header_height-6,left:i-2,width:6,height:6,classes:"animated-ball-highlight",append_to:this.$header,style:"background: var(--g-custom-highlight); border-radius: 50%; z-index: 1001;"}),this.options.player_state){let r=(this.options.player_interval||1e3)/1e3,h=this.config.column_width;if(this.config.player_end_date&&s>=this.config.player_end_date)return{left:i,dateObj:s};this.config.player_end_date&&_.add(s,this.config.step,this.config.unit)>this.config.player_end_date&&(r=_.diff(this.config.player_end_date,s,"millisecond")/(this.options.player_interval||1e3),h=_.diff(this.config.player_end_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width-i),[this.$animated_highlight,this.$animated_ball_highlight].forEach(d=>{d.style.setProperty("--animation-duration",`${r}s`),d.style.setProperty("--move-distance",`${h}px`),d.style.animation="none",d.offsetHeight,d.style.animation=`moveRight ${r}s linear forwards`,d.style.animationPlayState="running"}),this.lastAnimationStart=performance.now()}else[this.$animated_highlight,this.$animated_ball_highlight].forEach(r=>{r.style.animation="none",r.style.animationPlayState="paused"});return{left:i,dateObj:s}}toggle_play(){if(this.config.custom_marker_date||(this.config.custom_marker_date=this.options.custom_marker_init_date||new Date),this.options.player_state=!this.options.player_state,this.options.player_state){console.log("toggle_play: Starting playback, custom_marker_date:",this.config.custom_marker_date),this.task_update(performance.now()),this.flushEventQueue(),this.flushViewerUpdates(),this.player_interval=setInterval(this.player_update.bind(this),this.options.player_interval||1e3),this.taskInterval=setInterval(this.task_update.bind(this,performance.now()),this.options.task_interval),this.trigger_event("start",[]),this.options.player_use_fa?(this.$player_button.classList.remove("fa-play"),this.$player_button.classList.add("fa-pause")):this.$player_button.textContent="Pause";const e=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;console.log("toggle_play: Initial highlight position:",e),this.play_animated_highlight(e,this.config.custom_marker_date)}else console.log("toggle_play: Stopping playback"),clearInterval(this.player_interval),clearInterval(this.taskInterval),this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this.flushEventQueue(),this.flushViewerUpdates(),this.player_interval=null,this.taskInterval=null,this.trigger_event("pause",[]),this.options.player_use_fa?(this.$player_button.classList.remove("fa-pause"),this.$player_button.classList.add("fa-play")):this.$player_button.textContent="Play",this.$animated_highlight&&(this.$animated_highlight.style.animationPlayState="paused"),this.$animated_ball_highlight&&(this.$animated_ball_highlight.style.animationPlayState="paused")}task_update(t){if(!this.options.player_state){console.log("task_update: Exited, player_state is false");return}if(!this.config.custom_marker_date){console.log("task_update: Exited, no custom_marker_date");return}this.config.custom_marker_date<this.gantt_start&&console.warn(`task_update: custom_marker_date=${this.config.custom_marker_date} is before gantt_start=${this.gantt_start}`);const i=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;console.log("task_update: currentLeft:",i,"custom_marker_date:",this.config.custom_marker_date);const s=this.tasks.filter(d=>{var c,p,g,u;const l=((g=(p=(c=this.options.phasing_config)==null?void 0:c.objects)==null?void 0:p[d.id])==null?void 0:g.length)>0;return!((u=this.options.phasing_config)!=null&&u.objects)||!Object.keys(this.options.phasing_config.objects).length?(console.log(`task_update: No or empty phasing_config.objects, including task id=${d.id}`),!0):(console.log(`task_update: Task id=${d.id}, hasDbIds=${l}`),l)}).map(d=>{const l=_.diff(d._start,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width,c=_.diff(d._end,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;return console.log(`task_update: Task id=${d.id}, startX=${l}, endX=${c}, start=${d._start}, end=${d._end}`),{task:d,startX:l,endX:c}}),a=new Set(s.filter(({startX:d,endX:l})=>d<=i&&i<=l).map(({task:d})=>d.id));console.log("task_update: new_overlapping tasks:",[...a]);const o=[...a].filter(d=>!this.overlapping_tasks.has(d)),r=[...this.overlapping_tasks].filter(d=>!a.has(d));if(console.log("task_update: entered_tasks:",o,"exited_tasks:",r),o.forEach(d=>{const l=this.get_task(d);this.eventQueue.set(d,{task:l,state:"enter"})}),r.forEach(d=>{const l=this.get_task(d);this.eventQueue.set(d,{task:l,state:"exit"})}),this.overlapping_tasks=a,console.log("task_update: eventQueue size:",this.eventQueue.size),this.config.player_end_date&&this.config.custom_marker_date>=this.config.player_end_date||this.config.custom_marker_date>=this.gantt_end){console.log("task_update: Reached player_end_date or gantt_end, processing remaining tasks"),this.tasks.filter(l=>l._start<=this.gantt_end).forEach(l=>{!this.overlapping_tasks.has(l.id)&&l._start<=this.config.custom_marker_date&&(this.eventQueue.set(l.id,{task:l,state:"enter"}),console.log(`task_update: Queued final bar_enter for task id=${l.id}`)),l._end<=this.config.custom_marker_date&&(this.eventQueue.set(l.id,{task:l,state:"exit"}),console.log(`task_update: Queued final bar_exit for task id=${l.id}`))}),this.overlapping_tasks.clear(),this.flushEventQueue();return}const h=performance.now();h-this.lastEventUpdate>=this.options.event_debounce_interval&&(this.flushEventQueue(),this.lastEventUpdate=h)}debounceViewerUpdates(){var s,a,o,r,h,d,l,c,p;const t=Array.from(this.viewerUpdateQueue.entries());if(console.log("debounceViewerUpdates: Processing updates:",t.map(([g,{task:u,state:m}])=>({id:g,state:m,task_name:u.name}))),!t.length){console.log("debounceViewerUpdates: No updates to process");return}if(!this.options.dataVizExtn||!this.options.viewer){console.log("debounceViewerUpdates: Missing dataVizExtn or viewer");return}!this.shadingNodeCache.size&&((o=(a=(s=this.options.dataVizExtn)==null?void 0:s.surfaceShading)==null?void 0:a[1])!=null&&o.shadingData)&&(this.tasks.forEach(g=>{const u=this.options.dataVizExtn.surfaceShading[1].shadingData.getNodeById(g.name);u&&this.shadingNodeCache.set(g.id,u)}),console.log("debounceViewerUpdates: Cached shading nodes:",this.shadingNodeCache.size));const e=t.filter(([g,{state:u}])=>u==="enter").map(([g,{task:u}])=>u),i=t.filter(([g,{state:u}])=>u==="exit").map(([g,{task:u}])=>u);if(console.log("debounceViewerUpdates: enterTasks:",e.map(g=>g.name),"exitTasks:",i.map(g=>g.name)),e.length&&((h=(r=this.options.formattingOptions)==null?void 0:r.clear)!=null&&h.value)){const g=[];if(e.forEach(u=>{var b;const m=this.shadingNodeCache.get(u.id);m&&((b=m.dbIds)!=null&&b.length)&&g.push(...m.dbIds)}),g.length){console.log("debounceViewerUpdates: Showing dbIds:",g);const u=this.options.viewer,m=new Set(((l=(d=u.impl).getVisibleDbIds)==null?void 0:l.call(d))||((p=(c=u.model).getVisibleDbIds)==null?void 0:p.call(c))||[]),b=g.filter(M=>!m.has(M));b.length?u.show(b):console.log("debounceViewerUpdates: All dbIds already visible")}}if(e.length||i.length){const g={};e.forEach(u=>{g[u.name]=(m,b)=>.6}),i.forEach(u=>{g[u.name]=(m,b)=>.3}),console.log("debounceViewerUpdates: Applying shading updates:",Object.keys(g)),Object.entries(g).forEach(([u,m])=>{this.options.dataVizExtn.renderSurfaceShading(u,"Progress",m)})}this.viewerUpdateQueue.clear(),console.log("debounceViewerUpdates: Cleared viewerUpdateQueue")}flushEventQueue(){const t=Array.from(this.eventQueue.entries());console.log("flushEventQueue: Processing events:",t.map(([e,{task:i,state:s}])=>({id:e,state:s,task_name:i.name}))),t.length&&(t.forEach(([e,{task:i,state:s}])=>{console.log(`flushEventQueue: Triggering ${s} for task:`,i.name),s==="enter"?this.trigger_event("bar_enter",[i]):this.trigger_event("bar_exit",[i]),this.viewerUpdateQueue.set(e,{task:i,state:s})}),this.eventQueue.clear(),console.log("flushEventQueue: Cleared eventQueue"),this.flushViewerUpdates())}flushViewerUpdates(){this.debounceViewerUpdates(),this.lastViewerUpdate=performance.now()}reset_play(){var h;const t=this.options.view_mode||"Day";let e,i=-2;switch(t.toLowerCase()){case"hour":e="hour";break;case"quarter_day":e="hour",i=-2*6;break;case"half_day":e="hour",i=-2*12;break;case"day":e="day";break;case"week":e="week";break;case"month":e="month";break;case"year":e="year";break;default:e="day"}const s=this.options.custom_marker_init_date?new Date(this.options.custom_marker_init_date):new Date(((h=this.tasks[0])==null?void 0:h._start)||Date.now());let a=new Date(s);e==="week"?a.setDate(s.getDate()+i*7):e==="month"?a.setMonth(s.getMonth()+i):e==="year"?a.setFullYear(s.getFullYear()+i):a=_.add(s,i,e),this.config.custom_marker_date=a,console.log(`reset_play: view_mode=${t}, baseDate=${s}, offset=${i} ${e}, custom_marker_date=${this.config.custom_marker_date}`),this.options.player_state=!1,this.overlapping_tasks.clear(),this.lastTaskY=null,clearInterval(this.player_interval),clearInterval(this.taskInterval),this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this.flushEventQueue(),this.flushViewerUpdates(),this.eventQueue.clear(),this.viewerUpdateQueue.clear(),this.shadingNodeCache.clear(),this.player_interval=null,this.taskInterval=null,this.$player_button&&(this.options.player_use_fa?(this.$player_button.classList.remove("fa-pause"),this.$player_button.classList.add("fa-play")):this.$player_button.textContent="Play"),this.render();const r=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.play_animated_highlight(r,this.config.custom_marker_date),this.trigger_event("reset",[])}create_el({left:t,top:e,width:i,height:s,id:a,classes:o,append_to:r,type:h,style:d}){let l=document.createElement(h||"div");for(let c of o.split(" "))l.classList.add(c);return e!==void 0&&(l.style.top=e+"px"),t!==void 0&&(l.style.left=t+"px"),a&&(l.id=a),i&&(l.style.width=i+"px"),s&&(l.style.height=s+"px"),d&&(l.style.cssText=d),r&&r.appendChild(l),l}make_dates(){this.get_dates_to_draw().forEach((t,e)=>{if(t.lower_text){let i=this.create_el({left:t.x,top:t.lower_y,classes:"lower-text date_"+D(t.formatted_date),append_to:this.$lower_header});i.innerText=t.lower_text}if(t.upper_text){let i=this.create_el({left:t.x,top:t.upper_y,classes:"upper-text",append_to:this.$upper_header});i.innerText=t.upper_text}}),this.upperTexts=Array.from(this.$container.querySelectorAll(".upper-text"))}get_dates_to_draw(){let t=null;return this.dates.map((i,s)=>{const a=this.get_date_info(i,t,s);return t=a,a})}get_date_info(t,e){let i=e?e.date:null;this.config.column_width;const s=e?e.x+e.column_width:0;let a=this.config.view_mode.upper_text,o=this.config.view_mode.lower_text;return a?typeof a=="string"&&(this.config.view_mode.upper_text=r=>_.format(r,a,this.options.language)):this.config.view_mode.upper_text=()=>"",o?typeof o=="string"&&(this.config.view_mode.lower_text=r=>_.format(r,o,this.options.language)):this.config.view_mode.lower_text=()=>"",{date:t,formatted_date:D(_.format(t,this.config.date_format,this.options.language)),column_width:this.config.column_width,x:s,upper_text:this.config.view_mode.upper_text(t,i,this.options.language),lower_text:this.config.view_mode.lower_text(t,i,this.options.language),upper_y:17,lower_y:this.options.upper_header_height+5}}make_bars(){this.bars=this.tasks.map(t=>{const e=new Q(this,t);return this.layers.bar.appendChild(e.group),e})}make_arrows(){if(!this.tasks||!Array.isArray(this.tasks)){console.warn("make_arrows: No tasks available to process arrows"),this.arrows=[];return}this.arrows=[],this.tasks.forEach(e=>{e.dependencies&&Array.isArray(e.dependencies)&&e.dependencies.forEach(i=>{const s=this.get_task(i);if(!s)return;const a=new N(this,s._end,e._start,s._index,e._index);this.arrows.push(a),console.log(`make_arrows: Created arrow from task ${s.id} to ${e.id}`)})});const t=this.$svg.querySelector(".arrows");t&&(t.innerHTML="",this.arrows.forEach(e=>e.update()))}map_arrows_on_bars(){for(let t of this.bars)t.arrows=this.arrows.filter(e=>e.from_task.task.id===t.task.id||e.to_task.task.id===t.task.id)}set_dimensions(){const{width:t}=this.$svg.getBoundingClientRect(),e=this.$svg.querySelector(".grid .grid-row")?this.$svg.querySelector(".grid .grid-row").getAttribute("width"):0;t<e&&this.$svg.setAttribute("width",e)}set_scroll_position(t){if(this.options.infinite_padding&&(!t||t==="start")){let[o,...r]=this.get_start_end_positions();this.$container.scrollLeft=o;return}if(!t||t==="start")t=this.gantt_start;else if(t==="end")t=this.gantt_end;else{if(t==="today")return this.scroll_current();if(t==="custom")return this.scroll_custom_marker();typeof t=="string"&&(t=_.parse(t))}const i=_.diff(t,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$container.scrollTo({left:i-this.config.column_width/6,behavior:"smooth"}),this.$current&&this.$current.classList.remove("current-upper"),this.current_date=_.add(this.gantt_start,this.$container.scrollLeft/this.config.column_width,this.config.unit);let s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),a=this.upperTexts.find(o=>o.textContent===s);this.current_date=_.add(this.gantt_start,(this.$container.scrollLeft+a.clientWidth)/this.config.column_width,this.config.unit),s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),a=this.upperTexts.find(o=>o.textContent===s),a.classList.add("current-upper"),this.$current=a}scroll_current(){let t=this.get_closest_date();t&&this.set_scroll_position(t[0])}scroll_custom_marker(){const t=this.get_closest_date_to(this.config.custom_marker_date);t&&this.config.player_end_date&&t[0]>=this.config.player_end_date&&this.handle_animation_end()}scroll_to_latest_task(){if(!this.tasks.length)return;const t=this.config.custom_marker_date||this.gantt_start,e=this.tasks.filter(p=>p._start<=t&&t<=p._end),i=e.length?e.reduce((p,g)=>g._index<p._index?g:p,e[0]):this.tasks.reduce((p,g)=>g._start<p._start?g:p,this.tasks[0]),s=this.$svg.querySelector(`.bar-wrapper[data-id="${i.id}"]`);let a;s?(a=parseFloat(s.getAttribute("y"))||0,a===0&&(a=this.config.header_height+i._index*(this.options.bar_height+this.options.padding))):a=this.config.header_height+i._index*(this.options.bar_height+this.options.padding),this.lastTaskY=a;const o=a-this.config.header_height,r=this.$container.clientHeight,h=this.options.padding;let d=o-h;const l=this.$container.scrollHeight-r,c=Math.max(0,Math.min(d,l));this.$container.scrollTo({top:c,behavior:"smooth"})}player_update(){if(!this.options.player_state){console.log("player_update: Exited, player_state is false");return}if(this.config.player_end_date&&this.config.custom_marker_date>=this.config.player_end_date){console.log("player_update: Reached player_end_date, stopping"),this.handle_animation_end();return}this.config.custom_marker_date=_.add(this.config.custom_marker_date,this.config.step,this.config.unit),this.task_update(performance.now());const e=_.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;if(this.$animated_highlight&&this.$animated_ball_highlight){this.$animated_highlight.style.left=`${e}px`,this.$animated_ball_highlight.style.left=`${e-2}px`;const i=(this.options.player_interval||1e3)/1e3,s=this.config.column_width;[this.$animated_highlight,this.$animated_ball_highlight].forEach(a=>{a.style.setProperty("--animation-duration",`${i}s`),a.style.setProperty("--move-distance",`${s}px`),a.style.animation="none",a.offsetHeight,a.style.animation=`moveRight ${i}s linear forwards`,a.style.animationPlayState="running"})}this.start_scroll_animation(e)}start_scroll_animation(t){if(this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),!this.options.player_state){console.log("start_scroll_animation exited: player_state is false");return}const e=(this.options.player_interval||1e3)/1e3,i=this.config.column_width,s=performance.now(),a=this.$container,o=a.clientWidth,r=a.scrollWidth-o,h=o/6,d=l=>{if(!this.options.player_state){console.log("animateScroll exited: player_state is false"),this.scrollAnimationFrame=null;return}const c=(l-s)/1e3,p=Math.min(c/e,1);let u=t+i*p-h;if(u=Math.max(0,Math.min(u,r)),a.scrollLeft=u,this.tasks.length){const M=this.config.custom_marker_date,T=this.tasks.filter(k=>k._start<=M&&M<=k._end);let y;if(T.length){const k=T.reduce((L,A)=>A._index<L._index?A:L,T[0]),Y=this.$svg.querySelector(`.bar-wrapper[data-id="${k.id}"]`);Y?(y=parseFloat(Y.getAttribute("y"))||0,y===0&&(y=this.config.header_height+k._index*(this.options.bar_height+this.options.padding))):y=this.config.header_height+k._index*(this.options.bar_height+this.options.padding),this.lastTaskY=y}else if(this.lastTaskY!==null)y=this.lastTaskY;else{const k=this.tasks.reduce((L,A)=>A._start<L._start?A:L,this.tasks[0]),Y=this.$svg.querySelector(`.bar-wrapper[data-id="${k.id}"]`);Y?(y=parseFloat(Y.getAttribute("y"))||0,y===0&&(y=this.config.header_height+k._index*(this.options.bar_height+this.options.padding))):y=this.config.header_height+k._index*(this.options.bar_height+this.options.padding),this.lastTaskY=y}const B=y-this.config.header_height,R=a.clientHeight,G=this.options.padding;let Z=B-G;const K=a.scrollHeight-R,J=Math.max(0,Math.min(Z,K));a.scrollTop=J}const m=this.get_closest_date_to(this.config.custom_marker_date),b=m&&this.config.player_end_date?m[0]>=this.config.player_end_date:!1;p<1&&!b?this.scrollAnimationFrame=requestAnimationFrame(d):(this.scrollAnimationFrame=null,b&&this.handle_animation_end())};this.scrollAnimationFrame=requestAnimationFrame(d)}handle_animation_end(){var t;try{if(this.player_interval&&(clearInterval(this.player_interval),this.player_interval=null),this.taskInterval&&(clearInterval(this.taskInterval),this.taskInterval=null),this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this.tasks.filter(i=>i._start<=this.gantt_end).forEach(i=>{this.overlapping_tasks.has(i.id)||(this.eventQueue.set(i.id,{task:i,state:"enter"}),console.log(`handle_animation_end: Queued final bar_enter for task id=${i.id}`)),this.eventQueue.set(i.id,{task:i,state:"exit"}),console.log(`handle_animation_end: Queued final bar_exit for task id=${i.id}`)}),this.overlapping_tasks.clear(),this.flushEventQueue(),this.flushViewerUpdates(),this.eventQueue.clear(),this.viewerUpdateQueue.clear(),this.shadingNodeCache.clear(),this.options.player_loop){const i=this.options.view_mode||"Day";let s,a=-2;switch(i.toLowerCase()){case"hour":s="hour";break;case"quarter_day":s="hour",a=-2*6;break;case"half_day":s="hour",a=-2*12;break;case"day":s="day";break;case"week":s="week";break;case"month":s="month";break;case"year":s="year";break;default:s="day"}const o=this.options.custom_marker_init_date?new Date(this.options.custom_marker_init_date):new Date(((t=this.tasks[0])==null?void 0:t._start)||Date.now());let r=new Date(o);s==="week"?r.setDate(o.getDate()+a*7):s==="month"?r.setMonth(o.getMonth()+a):s==="year"?r.setFullYear(o.getFullYear()+a):r=_.add(o,a,s),this.config.custom_marker_date=r,console.log(`handle_animation_end: view_mode=${i}, baseDate=${o}, offset=${a} ${s}, custom_marker_date=${this.config.custom_marker_date}`),this.overlapping_tasks.clear(),this.lastTaskY=null,this.reset_play(),this.toggle_play()}else this.options.player_state=!1,this.overlapping_tasks.clear(),this.lastTaskY=null,this.$player_button&&(this.options.player_use_fa?(this.$player_button.classList.remove("fa-pause"),this.$player_button.classList.add("fa-play")):this.$player_button.textContent="Play"),this.$animated_highlight&&(this.$animated_highlight.style.animation="none",this.$animated_highlight.style.animationPlayState="paused"),this.$animated_ball_highlight&&(this.$animated_ball_highlight.style.animation="none",this.$animated_ball_highlight.style.animationPlayState="paused"),this.trigger_event("finish",[])}catch(e){console.error("Error in handle_animation_end:",e)}}get_closest_date_to(t){let e=t;if(e<this.gantt_start||e>this.gantt_end)return null;let i=t,s=this.$container.querySelector(".date_"+D(_.format(i,this.config.date_format,this.options.language))),a=0;for(;!s&&a<this.config.step;)i=_.add(i,-1,this.config.unit),s=this.$container.querySelector(".date_"+D(_.format(i,this.config.date_format,this.options.language))),a++;return[new Date(_.format(i,this.config.date_format,this.options.language)+" "),s]}get_closest_date(){let t=new Date;if(t<this.gantt_start||t>this.gantt_end)return null;let e=new Date,i=this.$container.querySelector(".date_"+D(_.format(e,this.config.date_format,this.options.language))),s=0;for(;!i&&s<this.config.step;)e=_.add(e,-1,this.config.unit),i=this.$container.querySelector(".date_"+D(_.format(e,this.config.date_format,this.options.language))),s++;return[new Date(_.format(e,this.config.date_format,this.options.language)+" "),i]}bind_grid_click(){f.on(this.$container,"click",".grid-row, .grid-header, .ignored-bar, .holiday-highlight",()=>{this.unselect_all(),this.hide_popup()})}bind_holiday_labels(){const t=this.$container.querySelectorAll(".holiday-highlight");for(let e of t){const i=this.$container.querySelector(".label_"+e.classList[1]);if(!i)continue;let s;e.onmouseenter=a=>{s=setTimeout(()=>{i.classList.add("show"),i.style.left=(a.offsetX||a.layerX)+"px",i.style.top=(a.offsetY||a.layerY)+"px"},300)},e.onmouseleave=a=>{clearTimeout(s),i.classList.remove("show")}}}get_start_end_positions(){if(!this.bars.length)return[0,0,0];let{x:t,width:e}=this.bars[0].group.getBBox(),i=t,s=t,a=t+e;return Array.prototype.forEach.call(this.bars,function({group:o},r){let{x:h,width:d}=o.getBBox();h<i&&(i=h),h>s&&(s=h),h+d>a&&(a=h+d)}),[i,s,a]}bind_bar_events(){let t=!1,e=0,i=0,s=!1,a=!1,o=null,r=[];this.bar_being_dragged=null;const h=()=>t||s||a;this.$svg.onclick=l=>{l.target.classList.contains("grid-row")&&this.unselect_all()};let d=0;if(f.on(this.$svg,"mousemove",".bar-wrapper, .handle",l=>{this.bar_being_dragged===!1&&Math.abs((l.offsetX||l.layerX)-d)>10&&(this.bar_being_dragged=!0)}),f.on(this.$svg,"mousedown",".bar-wrapper, .handle",(l,c)=>{const p=f.closest(".bar-wrapper",c);c.classList.contains("left")?(s=!0,c.classList.add("visible")):c.classList.contains("right")?(a=!0,c.classList.add("visible")):c.classList.contains("bar-wrapper")&&(t=!0),this.popup&&this.popup.hide(),e=l.offsetX||l.layerX,l.offsetY||l.layerY,o=p.getAttribute("data-id");let g;this.options.move_dependencies?g=[o,...this.get_all_dependent_tasks(o)]:g=[o],r=g.map(u=>this.get_bar(u)),this.bar_being_dragged=!1,d=e,r.forEach(u=>{const m=u.$bar;m.ox=m.getX(),m.oy=m.getY(),m.owidth=m.getWidth(),m.finaldx=0})}),this.options.infinite_padding){let l=!1;f.on(this.$container,"mousewheel",c=>{let p=this.$container.scrollWidth/2;if(!l&&c.currentTarget.scrollLeft<=p){let g=c.currentTarget.scrollLeft;l=!0,this.gantt_start=_.add(this.gantt_start,-this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),c.currentTarget.scrollLeft=g+this.config.column_width*this.config.extend_by_units,setTimeout(()=>l=!1,300)}if(!l&&c.currentTarget.scrollWidth-(c.currentTarget.scrollLeft+c.currentTarget.clientWidth)<=p){let g=c.currentTarget.scrollLeft;l=!0,this.gantt_end=_.add(this.gantt_end,this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),c.currentTarget.scrollLeft=g,setTimeout(()=>l=!1,300)}})}f.on(this.$container,"scroll",l=>{let c=[];const p=this.bars.map(({group:y})=>y.getAttribute("data-id"));let g;i&&(g=l.currentTarget.scrollLeft-i),this.current_date=_.add(this.gantt_start,l.currentTarget.scrollLeft/this.config.column_width*this.config.step,this.config.unit);let u=this.config.view_mode.upper_text(this.current_date,null,this.options.language),m=this.upperTexts.find(y=>y.textContent===u);this.current_date=_.add(this.gantt_start,(l.currentTarget.scrollLeft+m.clientWidth)/this.config.column_width*this.config.step,this.config.unit),u=this.config.view_mode.upper_text(this.current_date,null,this.options.language),m=this.upperTexts.find(y=>y.textContent===u),m!==this.$current&&(this.$current&&this.$current.classList.remove("current-upper"),m.classList.add("current-upper"),this.$current=m),i=l.currentTarget.scrollLeft;let[b,M,T]=this.get_start_end_positions();i>T+100?(this.$adjust.innerHTML="←",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:M,behavior:"smooth"})}):i+l.currentTarget.offsetWidth<b-100?(this.$adjust.innerHTML="→",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:b,behavior:"smooth"})}):this.$adjust.classList.add("hide"),g&&(c=p.map(y=>this.get_bar(y)),this.options.auto_move_label&&c.forEach(y=>{y.update_label_position_on_horizontal_scroll({x:g,sx:l.currentTarget.scrollLeft})}))}),f.on(this.$svg,"mousemove",l=>{if(!h())return;const c=(l.offsetX||l.layerX)-e;r.forEach(p=>{const g=p.$bar;g.finaldx=this.get_snap_position(c,g.ox),this.hide_popup(),s?o===p.task.id?p.update_bar_position({x:g.ox+g.finaldx,width:g.owidth-g.finaldx}):p.update_bar_position({x:g.ox+g.finaldx}):a?o===p.task.id&&p.update_bar_position({width:g.owidth+g.finaldx}):t&&!this.options.readonly&&!this.options.readonly_dates&&p.update_bar_position({x:g.ox+g.finaldx})})}),document.addEventListener("mouseup",()=>{var l,c,p;t=!1,s=!1,a=!1,(p=(c=(l=this.$container.querySelector(".visible"))==null?void 0:l.classList)==null?void 0:c.remove)==null||p.call(c,"visible")}),f.on(this.$svg,"mouseup",l=>{this.bar_being_dragged=null,r.forEach(c=>{c.$bar.finaldx&&(c.date_changed(),c.compute_progress(),c.set_action_completed())})}),this.bind_bar_progress()}bind_bar_progress(){let t=0,e=null,i=null,s=null,a=null;f.on(this.$svg,"mousedown",".handle.progress",(r,h)=>{e=!0,t=r.offsetX||r.layerX,r.offsetY||r.layerY;const l=f.closest(".bar-wrapper",h).getAttribute("data-id");i=this.get_bar(l),s=i.$bar_progress,a=i.$bar,s.finaldx=0,s.owidth=s.getWidth(),s.min_dx=-s.owidth,s.max_dx=a.getWidth()-s.getWidth()});const o=this.config.ignored_positions.map(r=>[r,r+this.config.column_width]);f.on(this.$svg,"mousemove",r=>{if(!e)return;let h=r.offsetX||r.layerX;if(h>t){let c=o.find(([p,g])=>h>=p&&h<g);for(;c;)h=c[1],c=o.find(([p,g])=>h>=p&&h<g)}else{let c=o.find(([p,g])=>h>p&&h<=g);for(;c;)h=c[0],c=o.find(([p,g])=>h>p&&h<=g)}let l=h-t;l>s.max_dx&&(l=s.max_dx),l<s.min_dx&&(l=s.min_dx),s.setAttribute("width",s.owidth+l),f.attr(i.$handle_progression,f.attr(i.$handle_progress,"cx",s.getEndX())),s.finaldx=l}),f.on(this.$svg,"mouseup",()=>{e=!1,s&&s.finaldx&&(s.finaldx=0,i.progress_changed(),i.set_action_completed(),i=null,s=null,a=null)})}get_all_dependent_tasks(t){let e=[],i=[t];for(;i.length;){const s=i.reduce((a,o)=>(a=a.concat(this.dependency_map[o]),a),[]);e=e.concat(s),i=s.filter(a=>!i.includes(a))}return e.filter(Boolean)}get_snap_position(t,e){let i=1;const s=this.options.snap_at||this.config.view_mode.snap_at||"1d";if(s!=="unit"){const{duration:l,scale:c}=_.parse_duration(s);i=_.convert_scales(this.config.view_mode.step,c)/l}const a=t%(this.config.column_width/i);let o=t-a+(a<this.config.column_width/i*2?0:this.config.column_width/i),r=e+o;const h=o>0?1:-1;let d=this.get_ignored_region(r,h);for(;d.length;)r+=this.config.column_width*h,d=this.get_ignored_region(r,h),d.length||(r-=this.config.column_width*h);return r-e}get_ignored_region(t,e=1){return e===1?this.config.ignored_positions.filter(i=>t>i&&t<=i+this.config.column_width):this.config.ignored_positions.filter(i=>t>=i&&t<i+this.config.column_width)}unselect_all(){this.popup&&this.popup.parent.classList.add("hide"),this.$container.querySelectorAll(".date-range-highlight").forEach(t=>t.classList.add("hide"))}view_is(t){return typeof t=="string"?this.config.view_mode.name===t:Array.isArray(t)?t.some(view_is):this.config.view_mode.name===t.name}get_task(t){return this.tasks.find(e=>e.id===t)}get_bar(t){return this.bars.find(e=>e.task.id===t)}show_popup(t){this.options.popup!==!1&&(this.popup||(this.popup=new j(this.$popup_wrapper,this.options.popup,this)),this.popup.show(t))}hide_popup(){this.popup&&this.popup.hide()}trigger_event(t,e){this.options["on_"+t]&&this.options["on_"+t].apply(this,e)}get_oldest_starting_date(){return this.tasks.length?this.tasks.map(t=>t._start).reduce((t,e)=>e<=t?e:t):new Date}clear(){var t,e,i,s,a,o,r,h,d,l,c,p;this.$svg.innerHTML="",(e=(t=this.$header)==null?void 0:t.remove)==null||e.call(t),(s=(i=this.$side_header)==null?void 0:i.remove)==null||s.call(i),(o=(a=this.$current_highlight)==null?void 0:a.remove)==null||o.call(a),(h=(r=this.$current_ball_highlight)==null?void 0:r.remove)==null||h.call(r),(l=(d=this.$extras)==null?void 0:d.remove)==null||l.call(d),(p=(c=this.popup)==null?void 0:c.hide)==null||p.call(c),this.$animated_highlight&&(this.$animated_highlight.remove(),this.$animated_highlight=null),this.$animated_ball_highlight&&(this.$animated_ball_highlight.remove(),this.$animated_ball_highlight=null)}}q.VIEW_MODE={HOUR:$[0],QUARTER_DAY:$[1],HALF_DAY:$[2],DAY:$[3],WEEK:$[4],MONTH:$[5],YEAR:$[6]};function P(n){return n.name+"_"+Math.random().toString(36).slice(2,12)}function D(n){return n.replaceAll(" ","_").replaceAll(":","_").replaceAll(".","_")}return q});
