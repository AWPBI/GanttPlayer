(function($,x){typeof exports=="object"&&typeof module<"u"?module.exports=x():typeof define=="function"&&define.amd?define(x):($=typeof globalThis<"u"?globalThis:$||self,$.Gantt=x())})(this,function(){"use strict";const $="year",x="month",S="day",A="hour",Y="minute",E="second",q="millisecond",d={parse_duration(a){const t=/([0-9]+)(y|m|d|h|min|s|ms)/gm.exec(a);if(t!==null){if(t[2]==="y")return{duration:parseInt(t[1]),scale:"year"};if(t[2]==="m")return{duration:parseInt(t[1]),scale:"month"};if(t[2]==="d")return{duration:parseInt(t[1]),scale:"day"};if(t[2]==="h")return{duration:parseInt(t[1]),scale:"hour"};if(t[2]==="min")return{duration:parseInt(t[1]),scale:"minute"};if(t[2]==="s")return{duration:parseInt(t[1]),scale:"second"};if(t[2]==="ms")return{duration:parseInt(t[1]),scale:"millisecond"}}},parse(a,e="-",t=/[.:]/){if(a instanceof Date)return a;if(typeof a=="string"){let i,s;const n=a.split(" ");i=n[0].split(e).map(o=>parseInt(o,10)),s=n[1]&&n[1].split(t),i[1]=i[1]?i[1]-1:0;let r=i;return s&&s.length&&(s.length===4&&(s[3]="0."+s[3],s[3]=parseFloat(s[3])*1e3),r=r.concat(s)),new Date(...r)}},to_string(a,e=!1){if(!(a instanceof Date))throw new TypeError("Invalid argument type");const t=this.get_date_values(a).map((n,r)=>(r===1&&(n=n+1),r===6?T(n+"",3,"0"):T(n+"",2,"0"))),i=`${t[0]}-${t[1]}-${t[2]}`,s=`${t[3]}:${t[4]}:${t[5]}.${t[6]}`;return i+(e?" "+s:"")},format(a,e="YYYY-MM-DD HH:mm:ss.SSS",t="en"){const i=new Intl.DateTimeFormat(t,{month:"long"}),s=new Intl.DateTimeFormat(t,{month:"short"}),n=i.format(a),r=n.charAt(0).toUpperCase()+n.slice(1),o=this.get_date_values(a).map(h=>T(h,2,0)),l={YYYY:o[0],MM:T(+o[1]+1,2,0),DD:o[2],HH:o[3],mm:o[4],ss:o[5],SSS:o[6],D:o[2],MMMM:r,MMM:s.format(a)};let c=e;const g=[];return Object.keys(l).sort((h,_)=>_.length-h.length).forEach(h=>{c.includes(h)&&(c=c.replaceAll(h,`$${g.length}`),g.push(l[h]))}),g.forEach((h,_)=>{c=c.replaceAll(`$${_}`,h)}),c},diff(a,e,t="day"){let i,s,n,r,o,l,c;i=a-e+(e.getTimezoneOffset()-a.getTimezoneOffset())*6e4,s=i/1e3,r=s/60,n=r/60,o=n/24;let g=a.getFullYear()-e.getFullYear(),h=a.getMonth()-e.getMonth();return h+=o%30/30,l=g*12+h,a.getDate()<e.getDate()&&l--,c=l/12,t.endsWith("s")||(t+="s"),Math.round({milliseconds:i,seconds:s,minutes:r,hours:n,days:o,months:l,years:c}[t]*100)/100},today(){const a=this.get_date_values(new Date).slice(0,3);return new Date(...a)},now(){return new Date},add(a,e,t){e=parseInt(e,10);const i=[a.getFullYear()+(t===$?e:0),a.getMonth()+(t===x?e:0),a.getDate()+(t===S?e:0),a.getHours()+(t===A?e:0),a.getMinutes()+(t===Y?e:0),a.getSeconds()+(t===E?e:0),a.getMilliseconds()+(t===q?e:0)];return new Date(...i)},start_of(a,e){const t={[$]:6,[x]:5,[S]:4,[A]:3,[Y]:2,[E]:1,[q]:0};function i(n){const r=t[e];return t[n]<=r}const s=[a.getFullYear(),i($)?0:a.getMonth(),i(x)?1:a.getDate(),i(S)?0:a.getHours(),i(A)?0:a.getMinutes(),i(Y)?0:a.getSeconds(),i(E)?0:a.getMilliseconds()];return new Date(...s)},clone(a){return new Date(...this.get_date_values(a))},get_date_values(a){return[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds()]},convert_scales(a,e){const t={millisecond:11574074074074074e-24,second:11574074074074073e-21,minute:.0006944444444444445,hour:.041666666666666664,day:1,month:30,year:365},{duration:i,scale:s}=this.parse_duration(a);return i*t[s]/t[e]},get_days_in_month(a){const e=[31,28,31,30,31,30,31,31,30,31,30,31],t=a.getMonth();if(t!==1)return e[t];const i=a.getFullYear();return i%4===0&&i%100!=0||i%400===0?29:28},get_days_in_year(a){return a.getFullYear()%4?365:366}};function T(a,e,t){return a=a+"",e=e>>0,t=String(typeof t<"u"?t:" "),a.length>e?String(a):(e=e-a.length,e>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(a))}function u(a,e){return typeof a=="string"?(e||document).querySelector(a):a||null}function m(a,e){const t=document.createElementNS("http://www.w3.org/2000/svg",a);for(let i in e)i==="append_to"?e.append_to.appendChild(t):i==="innerHTML"?t.innerHTML=e.innerHTML:i==="clipPath"?t.setAttribute("clip-path","url(#"+e[i]+")"):t.setAttribute(i,e[i]);return t}function H(a,e,t,i){const s=P(a,e,t,i);if(s===a){const n=document.createEvent("HTMLEvents");n.initEvent("click",!0,!0),n.eventName="click",s.dispatchEvent(n)}}function P(a,e,t,i,s="0.4s",n="0.1s"){const r=a.querySelector("animate");if(r)return u.attr(r,{attributeName:e,from:t,to:i,dur:s,begin:"click + "+n}),a;const o=m("animate",{attributeName:e,from:t,to:i,dur:s,begin:n,calcMode:"spline",values:t+";"+i,keyTimes:"0; 1",keySplines:j("ease-out")});return a.appendChild(o),a}function j(a){return{ease:".25 .1 .25 1",linear:"0 0 1 1","ease-in":".42 0 1 1","ease-out":"0 0 .58 1","ease-in-out":".42 0 .58 1"}[a]}u.on=(a,e,t,i)=>{i?u.delegate(a,e,t,i):(i=t,u.bind(a,e,i))},u.off=(a,e,t)=>{a.removeEventListener(e,t)},u.bind=(a,e,t)=>{e.split(/\s+/).forEach(function(i){a.addEventListener(i,t)})},u.delegate=(a,e,t,i)=>{a.addEventListener(e,function(s){const n=s.target.closest(t);n&&(s.delegatedTarget=n,i.call(this,s,n))})},u.closest=(a,e)=>e?e.matches(a)?e:u.closest(a,e.parentNode):null,u.attr=(a,e,t)=>{if(!t&&typeof e=="string")return a.getAttribute(e);if(typeof e=="object"){for(let i in e)u.attr(a,i,e[i]);return}a.setAttribute(e,t)};class z{constructor(e){this.gantt=e,this.overlapping_tasks=new Set,this.lastTaskY=null,this.eventQueue=[],this.isProcessingQueue=!1}async processEventQueue(e=!1){if(this.isProcessingQueue&&!e)return;this.isProcessingQueue=!0,console.log("Processing eventQueue:",this.eventQueue);const t=[...this.eventQueue];this.eventQueue=[];for(const{event:i,task:s}of t)try{console.log(`Executing ${i} for task ${s.id}`),await this.gantt.options["on_"+i](s)}catch(n){console.error(`Error processing ${i} for task ${s.id}:`,n)}this.isProcessingQueue=!1}player_update(){if(!this.gantt.options.player_state){console.log("player_update exited: player_state is false");return}const e=this.gantt.config.player_end_date?d.parse(this.gantt.config.player_end_date,"YYYY-MM-DD"):null;if(console.log("player_update: custom_marker_date=",this.gantt.config.custom_marker_date,"player_end_date=",e),e&&this.gantt.config.custom_marker_date>=e){console.log("player_update: reached player_end_date, stopping"),this.handle_animation_end();return}const t=new Date(this.gantt.config.custom_marker_date);this.gantt.config.custom_marker_date=d.add(this.gantt.config.custom_marker_date,this.gantt.config.step,this.gantt.config.unit),console.log("player_update: advanced to custom_marker_date=",this.gantt.config.custom_marker_date);const s=d.diff(this.gantt.config.custom_marker_date,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;if(this.gantt.$animated_highlight&&this.gantt.$animated_ball_highlight){this.gantt.$animated_highlight.style.left=`${s}px`,this.gantt.$animated_ball_highlight.style.left=`${s-2}px`;const n=(this.gantt.options.player_interval||1e3)/1e3,r=this.gantt.config.column_width;[this.gantt.$animated_highlight,this.gantt.$animated_ball_highlight].forEach(o=>{o.style.setProperty("--animation-duration",`${n}s`),o.style.setProperty("--move-distance",`${r}px`),o.style.animation="none",o.offsetHeight,o.style.animation=`moveRight ${n}s linear forwards`,o.style.animationPlayState="running"})}if(this.gantt.options.custom_marker){const n=this.gantt.config.custom_marker_date;this.gantt.tasks.filter(g=>g._start>=t&&g._start<n||g._end>t&&g._end<=n||g._start<=n&&n<g._end).forEach(g=>{this.overlapping_tasks.has(g.id)||(console.log(`player_update: Queuing bar_enter for task ${g.id}`),this.eventQueue.push({event:"bar_enter",task:g}),this.overlapping_tasks.add(g.id))});const o=new Set(this.gantt.tasks.filter(g=>g._start<=n&&n<g._end).map(g=>g.id)),l=[...o].filter(g=>!this.overlapping_tasks.has(g)),c=[...this.overlapping_tasks].filter(g=>!o.has(g));l.forEach(g=>{const h=this.gantt.get_task(g);console.log(`player_update: Queuing bar_enter for task ${g}`),this.eventQueue.push({event:"bar_enter",task:h})}),c.forEach(g=>{const h=this.gantt.get_task(g);console.log(`player_update: Queuing bar_exit for task ${g}`),this.eventQueue.push({event:"bar_exit",task:h})}),this.overlapping_tasks=o,console.log("player_update: eventQueue=",this.eventQueue),this.processEventQueue()}this.gantt.scrollManager.start_scroll_animation(s)}initializeEventQueue(){if(!this.gantt.options.custom_marker)return;const e=this.gantt.config.custom_marker_date,t=new Set(this.gantt.tasks.filter(i=>i._start<=e&&e<i._end).map(i=>i.id));t.forEach(i=>{if(!this.overlapping_tasks.has(i)){const s=this.gantt.get_task(i);this.eventQueue.push({event:"bar_enter",task:s})}}),this.overlapping_tasks=t,this.processEventQueue()}async handle_animation_end(){try{await this.processEventQueue(),this.gantt.player_interval&&(clearInterval(this.gantt.player_interval),this.gantt.player_interval=null),this.gantt.scrollAnimationFrame&&(cancelAnimationFrame(this.gantt.scrollAnimationFrame),this.gantt.scrollAnimationFrame=null),this.gantt.options.player_loop?(this.gantt.config.custom_marker_date=new Date(this.gantt.options.custom_marker_init_date),this.overlapping_tasks.clear(),this.lastTaskY=null,this.eventQueue=[],this.gantt.render(),this.gantt.reset_play(),this.gantt.toggle_play()):(this.gantt.options.player_state=!1,this.overlapping_tasks.clear(),this.lastTaskY=null,this.eventQueue=[],this.gantt.$player_button&&(this.gantt.options.player_use_fa?(this.gantt.$player_button.classList.remove("fa-pause"),this.gantt.$player_button.classList.add("fa-play"),this.gantt.$player_button.onclick=()=>{this.gantt.reset_play(),this.gantt.toggle_play()}):(this.gantt.$player_button.textContent="Play",this.gantt.$player_button.onclick=()=>{this.gantt.reset_play(),this.gantt.toggle_play()})),this.gantt.$animated_highlight&&(this.gantt.$animated_highlight.style.animation="none",this.gantt.$animated_highlight.style.animationPlayState="paused"),this.gantt.$animated_ball_highlight&&(this.gantt.$animated_ball_highlight.style.animation="none",this.gantt.$animated_ball_highlight.style.animationPlayState="paused"),this.gantt.trigger_event("finish",[]))}catch(e){console.error("Error in handle_animation_end:",e)}}}function I(a){return a.name+"_"+Math.random().toString(36).slice(2,12)}function k(a){return a.replaceAll(" ","_").replaceAll(":","_").replaceAll(".","_")}function p({left:a,top:e,width:t,height:i,id:s,classes:n,append_to:r,type:o,style:l}){let c=document.createElement(o||"div");for(let g of n.split(" "))g&&c.classList.add(g);return e!==void 0&&(c.style.top=e+"px"),a!==void 0&&(c.style.left=a+"px"),s&&(c.id=s),t&&(c.style.width=t+"px"),i&&(c.style.height=i+"px"),l&&(c.style.cssText=l),r&&r.appendChild(c),c}function R(a,e){return typeof e=="string"?a===e:Array.isArray(e)?e.includes(a):a===e.name}function B(a){return a.length?a.map(e=>e._start).reduce((e,t)=>t<=e?t:e):new Date}class V{constructor(e,t,i){this.parent=e,this.popup_func=t,this.gantt=i,this.make()}make(){this.parent.innerHTML=`
            <div class="title"></div>
            <div class="subtitle"></div>
            <div class="details"></div>
            <div class="actions"></div>
        `,this.hide(),this.title=this.parent.querySelector(".title"),this.subtitle=this.parent.querySelector(".subtitle"),this.details=this.parent.querySelector(".details"),this.actions=this.parent.querySelector(".actions")}show({x:e,y:t,task:i,target:s}){this.actions.innerHTML="";let n=this.popup_func({task:i,chart:this.gantt,get_title:()=>this.title,set_title:r=>this.title.innerHTML=r,get_subtitle:()=>this.subtitle,set_subtitle:r=>this.subtitle.innerHTML=r,get_details:()=>this.details,set_details:r=>this.details.innerHTML=r,add_action:(r,o)=>{let l=p({classes:"action-btn",type:"button",append_to:this.actions});typeof r=="function"&&(r=r(i)),l.innerHTML=r,l.onclick=c=>o(i,this.gantt,c)}});n!==!1&&(n&&(this.parent.innerHTML=n),this.actions.innerHTML===""?this.actions.remove():this.parent.appendChild(this.actions),this.parent.style.left=e+10+"px",this.parent.style.top=t-10+"px",this.parent.classList.remove("hide"))}hide(){this.parent.classList.add("hide")}}function C(a){const e=a.getFullYear();return e-e%10+""}function N(a,e,t){let i=d.add(a,6,"day"),s=i.getMonth()!==a.getMonth()?"D MMM":"D",n=!e||a.getMonth()!==e.getMonth()?"D MMM":"D";return`${d.format(a,n,t)} - ${d.format(i,s,t)}`}const b=[{name:"Hour",padding:"7d",step:"1h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,e,t)=>!e||a.getDate()!==e.getDate()?d.format(a,"D MMMM",t):"",upper_text_frequency:24},{name:"Quarter Day",padding:"7d",step:"6h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,e,t)=>!e||a.getDate()!==e.getDate()?d.format(a,"D MMM",t):"",upper_text_frequency:4},{name:"Half Day",padding:"14d",step:"12h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,e,t)=>!e||a.getDate()!==e.getDate()?a.getMonth()!==a.getMonth()?d.format(a,"D MMM",t):d.format(a,"D",t):"",upper_text_frequency:2},{name:"Day",padding:"7d",date_format:"YYYY-MM-DD",step:"1d",lower_text:(a,e,t)=>!e||a.getDate()!==e.getDate()?d.format(a,"D",t):"",upper_text:(a,e,t)=>!e||a.getMonth()!==e.getMonth()?d.format(a,"MMMM",t):"",thick_line:a=>a.getDay()===1},{name:"Week",padding:"1m",step:"7d",date_format:"YYYY-MM-DD",column_width:140,lower_text:N,upper_text:(a,e,t)=>!e||a.getMonth()!==e.getMonth()?d.format(a,"MMMM",t):"",thick_line:a=>a.getDate()>=1&&a.getDate()<=7,upper_text_frequency:4},{name:"Month",padding:"2m",step:"1m",column_width:120,date_format:"YYYY-MM",lower_text:"MMMM",upper_text:(a,e,t)=>!e||a.getFullYear()!==e.getFullYear()?d.format(a,"YYYY",t):"",thick_line:a=>a.getMonth()%3===0,snap_at:"7d"},{name:"Year",padding:"2y",step:"1y",column_width:120,date_format:"YYYY",upper_text:(a,e,t)=>!e||C(a)!==C(e)?C(a):"",lower_text:"YYYY",snap_at:"30d"}],G={arrow_curve:5,auto_move_label:!1,bar_corner_radius:3,bar_height:30,container_height:"auto",column_width:null,date_format:"YYYY-MM-DD HH:mm",upper_header_height:60,lower_header_height:30,snap_at:null,infinite_padding:!0,holidays:{"var(--g-weekend-highlight-color)":"weekend"},ignore:[],language:"en",lines:"both",move_dependencies:!0,padding:18,popup:a=>{a.set_title(a.task.name),a.task.description?a.set_subtitle(a.task.description):a.set_subtitle("");const e=d.format(a.task._start,"MMM D",a.chart.options.language),t=d.format(d.add(a.task._end,-1,"second"),"MMM D",a.chart.options.language);a.set_details(`${e} - ${t} (${a.task.actual_duration} days${a.task.ignored_duration?" + "+a.task.ignored_duration+" excluded":""})<br/>Progress: ${Math.floor(a.task.progress*100)/100}%`)},popup_on:"click",readonly_progress:!1,readonly_dates:!1,readonly:!1,scroll_to:"custom",show_expected_progress:!1,today_button:!0,view_mode:"Day",view_mode_select:!1,view_modes:b,custom_marker:!0,custom_marker_init_date:"2025-04-08T00:00:00Z",player_end_date:"2025-04-17T00:00:00Z",player_button:!0,player_interval:1e3,player_loop:!0,player_use_fa:!0};class U{constructor(e,t,i){this.gantt=e,this.from_task=t,this.to_task=i,this.calculate_path(),this.draw()}calculate_path(){let e=this.from_task.$bar.getX()+this.from_task.$bar.getWidth()/2;const t=()=>this.to_task.$bar.getX()<e+this.gantt.options.padding&&e>this.from_task.$bar.getX()+this.gantt.options.padding;for(;t();)e-=10;e-=10;let i=this.gantt.config.header_height+this.gantt.options.bar_height+(this.gantt.options.padding+this.gantt.options.bar_height)*this.from_task.task._index+this.gantt.options.padding/2,s=this.to_task.$bar.getX()-13,n=this.gantt.config.header_height+this.gantt.options.bar_height/2+(this.gantt.options.padding+this.gantt.options.bar_height)*this.to_task.task._index+this.gantt.options.padding/2;const r=this.from_task.task._index>this.to_task.task._index;let o=this.gantt.options.arrow_curve;const l=r?1:0;let c=r?-o:o;if(this.to_task.$bar.getX()<=this.from_task.$bar.getX()+this.gantt.options.padding){let g=this.gantt.options.padding/2-o;g<0&&(g=0,o=this.gantt.options.padding/2,c=r?-o:o);const h=this.to_task.$bar.getY()+this.to_task.$bar.getHeight()/2-c,_=this.to_task.$bar.getX()-this.gantt.options.padding;this.path=`
                M ${e} ${i}
                v ${g}
                a ${o} ${o} 0 0 1 ${-o} ${o}
                H ${_}
                a ${o} ${o} 0 0 ${l} ${-o} ${c}
                V ${h}
                a ${o} ${o} 0 0 ${l} ${o} ${c}
                L ${s} ${n}
                m -5 -5
                l 5 5
                l -5 5`}else{s<e+o&&(o=s-e);let g=r?n+o:n-o;this.path=`
              M ${e} ${i}
              V ${g}
              a ${o} ${o} 0 0 ${l} ${o} ${o}
              L ${s} ${n}
              m -5 -5
              l 5 5
              l -5 5`}}draw(){this.element=m("path",{d:this.path,"data-from":this.from_task.task.id,"data-to":this.to_task.task.id})}update(){this.calculate_path(),this.element.setAttribute("d",this.path)}}class Z{constructor(e,t){this.set_defaults(e,t),this.prepare_wrappers(),this.prepare_helpers(),this.refresh()}refresh(){this.bar_group.innerHTML="",this.handle_group.innerHTML="",this.task.custom_class?this.group.classList.add(this.task.custom_class):this.group.classList=["bar-wrapper"],this.prepare_values(),this.draw(),this.bind()}set_defaults(e,t){this.action_completed=!1,this.gantt=e,this.task=t,this.name=this.name||""}prepare_wrappers(){this.group=m("g",{class:"bar-wrapper"+(this.task.custom_class?" "+this.task.custom_class:""),"data-id":this.task.id}),this.bar_group=m("g",{class:"bar-group",append_to:this.group}),this.handle_group=m("g",{class:"handle-group",append_to:this.group})}prepare_values(){this.invalid=this.task.invalid,this.height=this.gantt.options.bar_height,this.image_size=this.height-5,this.task._start=new Date(this.task.start),this.task._end=new Date(this.task.end),this.compute_x(),this.compute_y(),this.compute_duration(),this.corner_radius=this.gantt.options.bar_corner_radius,this.width=this.gantt.config.column_width*this.duration,(!this.task.progress||this.task.progress<0)&&(this.task.progress=0),this.task.progress>100&&(this.task.progress=100)}prepare_helpers(){SVGElement.prototype.getX=function(){return+this.getAttribute("x")},SVGElement.prototype.getY=function(){return+this.getAttribute("y")},SVGElement.prototype.getWidth=function(){return+this.getAttribute("width")},SVGElement.prototype.getHeight=function(){return+this.getAttribute("height")},SVGElement.prototype.getEndX=function(){return this.getX()+this.getWidth()}}prepare_expected_progress_values(){this.compute_expected_progress(),this.expected_progress_width=this.gantt.options.column_width*this.duration*(this.expected_progress/100)||0}draw(){this.draw_bar(),this.draw_progress_bar(),this.gantt.options.show_expected_progress&&(this.prepare_expected_progress_values(),this.draw_expected_progress_bar()),this.draw_label(),this.draw_resize_handles(),this.task.thumbnail&&this.draw_thumbnail()}draw_bar(){this.$bar=m("rect",{x:this.x,y:this.y,width:this.width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar",append_to:this.bar_group}),this.task.color&&(this.$bar.style.fill=this.task.color),H(this.$bar,"width",0,this.width),this.invalid&&this.$bar.classList.add("bar-invalid")}draw_expected_progress_bar(){this.invalid||(this.$expected_bar_progress=m("rect",{x:this.x,y:this.y,width:this.expected_progress_width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar-expected-progress",append_to:this.bar_group}),H(this.$expected_bar_progress,"width",0,this.expected_progress_width))}draw_progress_bar(){if(this.invalid)return;this.progress_width=this.calculate_progress_width();let e=this.corner_radius;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(e=this.corner_radius+2),this.$bar_progress=m("rect",{x:this.x,y:this.y,width:this.progress_width,height:this.height,rx:e,ry:e,class:"bar-progress",append_to:this.bar_group}),this.task.color_progress&&(this.$bar_progress.style.fill=this.task.color_progress);const t=d.diff(this.task._start,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let i=p({classes:`date-range-highlight hide highlight-${this.task.id}`,width:this.width,left:t});this.$date_highlight=i,this.gantt.$lower_header.prepend(this.$date_highlight),H(this.$bar_progress,"width",0,this.progress_width)}calculate_progress_width(){const e=this.$bar.getWidth(),t=this.x+e,i=this.gantt.config.ignored_positions.reduce((l,c)=>l+(c>=this.x&&c<t),0)*this.gantt.config.column_width;let s=(e-i)*this.task.progress/100;const n=this.x+s,r=this.gantt.config.ignored_positions.reduce((l,c)=>l+(c>=this.x&&c<n),0)*this.gantt.config.column_width;s+=r;let o=this.gantt.eventHandler.get_ignored_region(this.x+s);for(;o.length;)s+=this.gantt.config.column_width,o=this.gantt.eventHandler.get_ignored_region(this.x+s);return this.progress_width=s,s}draw_label(){let e=this.x+this.$bar.getWidth()/2;this.task.thumbnail&&(e=this.x+this.image_size+5),m("text",{x:e,y:this.y+this.height/2,innerHTML:this.task.name,class:"bar-label",append_to:this.bar_group}),requestAnimationFrame(()=>this.update_label_position())}draw_thumbnail(){let e=10,t=2,i,s;i=m("defs",{append_to:this.bar_group}),m("rect",{id:"rect_"+this.task.id,x:this.x+e,y:this.y+t,width:this.image_size,height:this.image_size,rx:"15",class:"img_mask",append_to:i}),s=m("clipPath",{id:"clip_"+this.task.id,append_to:i}),m("use",{href:"#rect_"+this.task.id,append_to:s}),m("image",{x:this.x+e,y:this.y+t,width:this.image_size,height:this.image_size,class:"bar-img",href:this.task.thumbnail,clipPath:"clip_"+this.task.id,append_to:this.bar_group})}draw_resize_handles(){if(this.invalid||this.gantt.options.readonly)return;const e=this.$bar,t=3;if(this.handles=[],this.gantt.options.readonly_dates||(this.handles.push(m("rect",{x:e.getEndX()-t/2,y:e.getY()+this.height/4,width:t,height:this.height/2,rx:2,ry:2,class:"handle right",append_to:this.handle_group})),this.handles.push(m("rect",{x:e.getX()-t/2,y:e.getY()+this.height/4,width:t,height:this.height/2,rx:2,ry:2,class:"handle left",append_to:this.handle_group}))),!this.gantt.options.readonly_progress){const i=this.$bar_progress;this.$handle_progress=m("circle",{cx:i.getEndX(),cy:i.getY()+i.getHeight()/2,r:4.5,class:"handle progress",append_to:this.handle_group}),this.handles.push(this.$handle_progress)}for(let i of this.handles)u.on(i,"mouseenter",()=>i.classList.add("active")),u.on(i,"mouseleave",()=>i.classList.remove("active"))}bind(){this.invalid||this.setup_click_event()}setup_click_event(){let e=this.task.id;u.on(this.group,"mouseover",s=>{this.gantt.trigger_event("hover",[this.task,s.screenX,s.screenY,s])}),this.gantt.options.popup_on==="click"&&u.on(this.group,"mouseup",s=>{const n=s.offsetX||s.layerX;if(this.$handle_progress){const r=+this.$handle_progress.getAttribute("cx");if(r>n-1&&r<n+1||this.gantt.bar_being_dragged)return}this.gantt.show_popup({x:s.offsetX||s.layerX,y:s.offsetY||s.layerY,task:this.task,target:this.$bar})});let t;u.on(this.group,"mouseenter",s=>{t=setTimeout(()=>{this.gantt.options.popup_on==="hover"&&this.gantt.show_popup({x:s.offsetX||s.layerX,y:s.offsetY||s.layerY,task:this.task,target:this.$bar}),this.gantt.$container.querySelector(`.highlight-${e}`).classList.remove("hide")},200)}),u.on(this.group,"mouseleave",()=>{var s,n;clearTimeout(t),this.gantt.options.popup_on==="hover"&&((n=(s=this.gantt.popup)==null?void 0:s.hide)==null||n.call(s)),this.gantt.$container.querySelector(`.highlight-${e}`).classList.add("hide")}),u.on(this.group,"click",()=>{this.gantt.trigger_event("click",[this.task])}),u.on(this.group,"dblclick",s=>{this.action_completed||(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))});let i=!1;u.on(this.group,"touchstart",s=>{if(!i)return i=!0,setTimeout(function(){i=!1},300),!1;s.preventDefault(),!this.action_completed&&(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))})}update_bar_position({x:e=null,width:t=null}){const i=this.$bar;if(e){if(!this.task.dependencies.map(r=>this.gantt.get_bar(r).$bar.getX()).reduce((r,o)=>r&&e>=o,!0))return;this.update_attr(i,"x",e),this.x=e,this.$date_highlight.style.left=e+"px"}t>0&&(this.update_attr(i,"width",t),this.$date_highlight.style.width=t+"px"),this.update_label_position(),this.update_handle_position(),this.date_changed(),this.compute_duration(),this.gantt.options.show_expected_progress&&this.update_expected_progressbar_position(),this.update_progressbar_position(),this.update_arrow_position()}update_label_position_on_horizontal_scroll({x:e,sx:t}){const i=this.gantt.$container.querySelector(".gantt-container"),s=this.group.querySelector(".bar-label"),n=this.group.querySelector(".bar-img")||"",r=this.bar_group.querySelector(".img_mask")||"";let o=this.$bar.getX()+this.$bar.getWidth(),l=s.getX()+e,c=n&&n.getX()+e||0,g=n&&n.getBBox().width+7||7,h=l+s.getBBox().width+7,_=t+i.clientWidth/2;s.classList.contains("big")||(h<o&&e>0&&h<_||l-g>this.$bar.getX()&&e<0&&h>_)&&(s.setAttribute("x",l),n&&(n.setAttribute("x",c),r.setAttribute("x",c)))}date_changed(){let e=!1;const{new_start_date:t,new_end_date:i}=this.compute_start_end_date();Number(this.task._start)!==Number(t)&&(e=!0,this.task._start=t),Number(this.task._end)!==Number(i)&&(e=!0,this.task._end=i),e&&this.gantt.trigger_event("date_change",[this.task,t,d.add(i,-1,"second")])}progress_changed(){this.task.progress=this.compute_progress(),this.gantt.trigger_event("progress_change",[this.task,this.task.progress])}set_action_completed(){this.action_completed=!0,setTimeout(()=>this.action_completed=!1,1e3)}compute_start_end_date(){const e=this.$bar,t=e.getX()/this.gantt.config.column_width;let i=d.add(this.gantt.gantt_start,t*this.gantt.config.step,this.gantt.config.unit);const s=e.getWidth()/this.gantt.config.column_width,n=d.add(i,s*this.gantt.config.step,this.gantt.config.unit);return{new_start_date:i,new_end_date:n}}compute_progress(){this.progress_width=this.$bar_progress.getWidth(),this.x=this.$bar_progress.getBBox().x;const e=this.x+this.progress_width,t=this.progress_width-this.gantt.config.ignored_positions.reduce((s,n)=>s+(n>=this.x&&n<=e),0)*this.gantt.config.column_width;if(t<0)return 0;const i=this.$bar.getWidth()-this.ignored_duration_raw*this.gantt.config.column_width;return parseInt(t/i*100,10)}compute_expected_progress(){this.expected_progress=d.diff(d.today(),this.task._start,"hour")/this.gantt.config.step,this.expected_progress=(this.expected_progress<this.duration?this.expected_progress:this.duration)*100/this.duration}compute_x(){const{column_width:e}=this.gantt.config,t=this.task._start,i=this.gantt.gantt_start;let n=d.diff(t,i,this.gantt.config.unit)/this.gantt.config.step*e;this.x=n}compute_y(){this.y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding)}compute_duration(){let e=0,t=0;for(let i=new Date(this.task._start);i<this.task._end;i.setDate(i.getDate()+1))t++,!this.gantt.config.ignored_dates.find(s=>s.getTime()===i.getTime())&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(i))&&e++;this.task.actual_duration=e,this.task.ignored_duration=t-e,this.duration=d.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_duration_raw=d.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_duration_raw=this.duration-this.actual_duration_raw}update_attr(e,t,i){return i=+i,isNaN(i)||e.setAttribute(t,i),e}update_expected_progressbar_position(){this.invalid||(this.$expected_bar_progress.setAttribute("x",this.$bar.getX()),this.compute_expected_progress(),this.$expected_bar_progress.setAttribute("width",this.gantt.config.column_width*this.actual_duration_raw*(this.expected_progress/100)||0))}update_progressbar_position(){this.invalid||this.gantt.options.readonly||(this.$bar_progress.setAttribute("x",this.$bar.getX()),this.$bar_progress.setAttribute("width",this.calculate_progress_width()))}update_label_position(){const e=this.bar_group.querySelector(".img_mask")||"",t=this.$bar,i=this.group.querySelector(".bar-label"),s=this.group.querySelector(".bar-img");let n=5,r=this.image_size+10;const o=i.getBBox().width,l=t.getWidth();o>l?(i.classList.add("big"),s?(s.setAttribute("x",t.getEndX()+n),e.setAttribute("x",t.getEndX()+n),i.setAttribute("x",t.getEndX()+r)):i.setAttribute("x",t.getEndX()+n)):(i.classList.remove("big"),s?(s.setAttribute("x",t.getX()+n),e.setAttribute("x",t.getX()+n),i.setAttribute("x",t.getX()+l/2+r)):i.setAttribute("x",t.getX()+l/2-o/2))}update_handle_position(){if(this.invalid||this.gantt.options.readonly)return;const e=this.$bar;this.handle_group.querySelector(".handle.left").setAttribute("x",e.getX()),this.handle_group.querySelector(".handle.right").setAttribute("x",e.getEndX());const t=this.group.querySelector(".handle.progress");t&&t.setAttribute("cx",this.$bar_progress.getEndX())}update_arrow_position(){this.arrows=this.arrows||[];for(let e of this.arrows)e.update()}}class K{constructor(e){this.gantt=e}setup_layers(){this.gantt.layers={};const e=["grid","arrow","progress","bar"];for(let t of e)this.gantt.layers[t]=m("g",{class:t,append_to:this.gantt.$svg});this.gantt.$extras=p({classes:"extras",append_to:this.gantt.$container}),this.gantt.$adjust=p({classes:"adjust hide",append_to:this.gantt.$extras,type:"button"}),this.gantt.$adjust.innerHTML="←"}make_grid(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_side_header()}make_grid_extras(){this.make_grid_highlights(),this.make_grid_ticks()}make_grid_background(){const e=this.gantt.dates.length*this.gantt.config.column_width;this.gantt.config.header_height=90;const t=Math.max(this.gantt.config.header_height+this.gantt.options.padding+(this.gantt.options.bar_height+this.gantt.options.padding)*this.gantt.tasks.length-10,this.gantt.options.container_height!=="auto"?this.gantt.options.container_height:0);m("rect",{x:0,y:0,width:e,height:t,class:"grid-background",append_to:this.gantt.$svg}),this.gantt.$svg.setAttribute("height",t),this.gantt.$svg.setAttribute("width","100%"),this.gantt.grid_height=t,this.gantt.options.container_height==="auto"&&(this.gantt.$container.style.height=t+16+"px")}make_grid_rows(){const e=m("g",{append_to:this.gantt.layers.grid}),t=this.gantt.dates.length*this.gantt.config.column_width,i=this.gantt.options.bar_height+this.gantt.options.padding;for(let s=this.gantt.config.header_height;s<this.gantt.grid_height;s+=i)m("rect",{x:0,y:s,width:t,height:i,class:"grid-row",append_to:e})}make_grid_header(){this.gantt.$header=p({width:this.gantt.dates.length*this.gantt.config.column_width,classes:"grid-header",append_to:this.gantt.$container}),this.gantt.$upper_header=p({classes:"upper-header",append_to:this.gantt.$header}),this.gantt.$lower_header=p({classes:"lower-header",append_to:this.gantt.$header})}make_side_header(){if(this.gantt.$side_header&&document.body.contains(this.gantt.$side_header)){console.log("Reusing existing side-header:",this.gantt.$side_header),this.initializeDropdown();return}if(this.gantt.$side_header=p({classes:"side-header",append_to:this.gantt.$upper_header}),console.log("Side header created:",this.gantt.$side_header),this.gantt.options.today_button){const t=p({classes:"today-button",append_to:this.gantt.$side_header});t.textContent="Today",t.onclick=this.gantt.scroll_current.bind(this.gantt),this.gantt.$today_button=t,console.log("Today button created:",t)}if(this.gantt.options.player_button){const t=p({classes:"player-reset-button",append_to:this.gantt.$side_header});this.gantt.options.player_use_fa?t.classList.add("fas","fa-redo"):t.textContent="Reset",t.onclick=this.gantt.reset_play.bind(this.gantt),this.gantt.$player_reset_button=t,console.log("Player reset button created:",t)}if(this.gantt.options.player_button){const t=p({classes:"player-button",append_to:this.gantt.$side_header});this.gantt.options.player_use_fa?t.classList.add("fas",this.gantt.options.player_state?"fa-pause":"fa-play"):t.textContent="Play",t.onclick=this.gantt.toggle_play.bind(this.gantt),this.gantt.$player_button=t,console.log("Player button created:",t)}this.initializeDropdown()}initializeDropdown(){var l,c;if(!this.gantt.options.view_mode_select)return;console.log("View modes:",this.gantt.options.view_modes);let e=this.gantt.$side_header.querySelector(".dropdown-trigger");e||(e=p({classes:"dropdown-trigger",append_to:this.gantt.$side_header,type:"button"}),console.log("Dropdown trigger created:",e)),e.textContent=((l=this.gantt.config.view_mode)==null?void 0:l.name)||"Mode";let t=document.querySelector('.dropdown-menu[data-id="gantt-viewmode-menu"]');t?(console.log("Reusing existing dropdown menu:",t),t.innerHTML="",t.style.display="none"):(t=p({classes:"dropdown-menu",append_to:document.body}),t.setAttribute("data-id","gantt-viewmode-menu"),t.style.display="none",console.log("Dropdown menu created:",t)),this.gantt.$dropdownMenu=t,console.log("Dropdown menu display:",getComputedStyle(t).display),document.querySelectorAll('.dropdown-menu:not([data-id="gantt-viewmode-menu"])').forEach(g=>{console.log("Removing duplicate menu:",g),g.remove()}),console.log("Dropdown menu count:",document.querySelectorAll(".dropdown-menu").length);const s=p({classes:"",append_to:t}),n=p({classes:"dropdown-option disabled",append_to:s});n.textContent="Mode",n.dataset.value="";try{if(this.gantt.options.view_modes&&Symbol.iterator in Object(this.gantt.options.view_modes))for(const g of this.gantt.options.view_modes){if(!g||!g.name){console.warn("Invalid view mode:",g);continue}const h=p({tag:"li",classes:"dropdown-option",append_to:s});h.textContent=g.name,h.dataset.value=g.name,g.name===((c=this.gantt.config.view_mode)==null?void 0:c.name)&&(h.classList.add("selected"),e.textContent=g.name),h.addEventListener("click",_=>{_.stopPropagation(),h.dataset.value&&(console.log("Selected view mode:",h.dataset.value),this.gantt.viewManager.change_view_mode(h.dataset.value,!0),this.gantt.reset_play(),this.gantt.scrollManager.set_scroll_position("start"),e.textContent=h.textContent,s.querySelectorAll(".dropdown-option").forEach(f=>f.classList.remove("selected")),h.classList.add("selected"),t.classList.remove("show"),t.style.display="none",console.log("Dropdown closed after option select, display:",getComputedStyle(t).display),document.body.contains(this.gantt.$side_header)||(console.log("Side header missing, rebuilding..."),this.gantt.$side_header=null,this.make_side_header()))})}else console.error("view_modes is not iterable or undefined:",this.gantt.options.view_modes)}catch(g){console.error("Error populating dropdown:",g)}console.log("Dropdown options:",Array.from(s.querySelectorAll(".dropdown-option")).map(g=>g.textContent));const r=g=>{g.stopPropagation();const h=t.classList.contains("show");if(t.classList.toggle("show",!h),t.style.display=h?"none":"block",!h){const _=e.getBoundingClientRect();t.style.position="fixed",t.style.top=`${_.bottom+window.pageYOffset}px`,t.style.left=`${_.left+window.pageXOffset}px`,t.style.minWidth=`${_.width}px`,console.log("Trigger rect:",_)}console.log("Dropdown toggled:",t.classList.contains("show"),"display:",getComputedStyle(t).display)};this.gantt.dropdownToggleHandler&&e.removeEventListener("click",this.gantt.dropdownToggleHandler),this.gantt.dropdownToggleHandler=r,e.addEventListener("click",r);const o=g=>{!e.contains(g.target)&&!t.contains(g.target)&&(t.classList.remove("show"),t.style.display="none",console.log("Dropdown closed via outside click, display:",getComputedStyle(t).display))};this.gantt.dropdownCloseHandler&&document.removeEventListener("mousedown",this.gantt.dropdownCloseHandler,{capture:!0}),this.gantt.dropdownCloseHandler=o,document.addEventListener("mousedown",o,{capture:!0})}initializeDropdown(){var c,g;if(!this.gantt.options.view_mode_select)return;console.log("View modes:",this.gantt.options.view_modes);let e=this.gantt.$side_header.querySelector(".viewmode-select");e||(e=p({classes:"viewmode-select",append_to:this.gantt.$side_header}),console.log("Dropdown container created:",e));let t=e.querySelector(".dropdown-trigger");t||(t=p({classes:"dropdown-trigger",append_to:e,type:"button"}),console.log("Dropdown trigger created:",t)),t.textContent=((c=this.gantt.config.view_mode)==null?void 0:c.name)||"Mode";let i=document.querySelector('.dropdown-menu[data-id="gantt-viewmode-menu"]');i?(console.log("Reusing existing dropdown menu:",i),i.innerHTML="",i.style.display="none"):(i=p({classes:"dropdown-menu",append_to:document.body}),i.setAttribute("data-id","gantt-viewmode-menu"),i.style.display="none",console.log("Dropdown menu created:",i)),this.gantt.$dropdownMenu=i,console.log("Dropdown menu display:",getComputedStyle(i).display),document.querySelectorAll('.dropdown-menu:not([data-id="gantt-viewmode-menu"])').forEach(h=>{console.log("Removing duplicate menu:",h),h.remove()}),console.log("Dropdown menu count:",document.querySelectorAll(".dropdown-menu").length);const n=p({classes:"",append_to:i}),r=p({classes:"dropdown-option disabled",append_to:n});r.textContent="Mode",r.dataset.value="";try{if(this.gantt.options.view_modes&&Symbol.iterator in Object(this.gantt.options.view_modes))for(const h of this.gantt.options.view_modes){if(!h||!h.name){console.warn("Invalid view mode:",h);continue}const _=p({tag:"li",classes:"dropdown-option",append_to:n});_.textContent=h.name,_.dataset.value=h.name,h.name===((g=this.gantt.config.view_mode)==null?void 0:g.name)&&(_.classList.add("selected"),t.textContent=h.name),_.addEventListener("click",f=>{f.stopPropagation(),_.dataset.value&&(console.log("Selected view mode:",_.dataset.value),this.gantt.viewManager.change_view_mode(_.dataset.value,!0),this.gantt.reset_play(),this.gantt.scrollManager.set_scroll_position("start"),t.textContent=_.textContent,n.querySelectorAll(".dropdown-option").forEach(w=>w.classList.remove("selected")),_.classList.add("selected"),i.classList.remove("show"),i.style.display="none",console.log("Dropdown closed after option select, display:",getComputedStyle(i).display),document.body.contains(this.gantt.$side_header)||(console.log("Side header missing, rebuilding..."),this.gantt.$side_header=null,this.make_side_header()))})}else console.error("view_modes is not iterable or undefined:",this.gantt.options.view_modes)}catch(h){console.error("Error populating dropdown:",h)}console.log("Dropdown options:",Array.from(n.querySelectorAll(".dropdown-option")).map(h=>h.textContent));const o=h=>{h.stopPropagation();const _=i.classList.contains("show");if(i.classList.toggle("show",!_),i.style.display=_?"none":"block",!_){const f=t.getBoundingClientRect();i.style.position="fixed",i.style.top=`${f.bottom+window.pageYOffset}px`,i.style.left=`${f.left+window.pageXOffset}px`,i.style.minWidth=`${f.width}px`,console.log("Trigger rect:",f)}console.log("Dropdown toggled:",i.classList.contains("show"),"display:",getComputedStyle(i).display)};this.gantt.dropdownToggleHandler&&t.removeEventListener("click",this.gantt.dropdownToggleHandler),this.gantt.dropdownToggleHandler=o,t.addEventListener("click",o);const l=h=>{!e.contains(h.target)&&!i.contains(h.target)&&(i.classList.remove("show"),i.style.display="none",console.log("Dropdown closed via outside click, display:",getComputedStyle(i).display))};this.gantt.dropdownCloseHandler&&document.removeEventListener("mousedown",this.gantt.dropdownCloseHandler,{capture:!0}),this.gantt.dropdownCloseHandler=l,document.addEventListener("mousedown",l,{capture:!0})}initializeDropdown(){var c,g;if(!this.gantt.options.view_mode_select)return;console.log("View modes:",this.gantt.options.view_modes);let e=this.gantt.$side_header.querySelector(".viewmode-select");e||(e=p({classes:"viewmode-select",append_to:this.gantt.$side_header}),console.log("Dropdown container created:",e));let t=e.querySelector(".dropdown-trigger");t||(t=p({classes:"dropdown-trigger",append_to:e,type:"button"}),console.log("Dropdown trigger created:",t)),t.textContent=((c=this.gantt.config.view_mode)==null?void 0:c.name)||"Mode";let i=document.querySelector('.dropdown-menu[data-id="gantt-viewmode-menu"]');i?(console.log("Reusing existing dropdown menu:",i),i.innerHTML=""):(i=p({classes:"dropdown-menu",append_to:document.body}),i.setAttribute("data-id","gantt-viewmode-menu"),console.log("Dropdown menu created:",i)),this.gantt.$dropdownMenu=i,document.querySelectorAll('.dropdown-menu:not([data-id="gantt-viewmode-menu"])').forEach(h=>{console.log("Removing duplicate menu:",h),h.remove()}),console.log("Dropdown menu count:",document.querySelectorAll(".dropdown-menu").length);const n=p({classes:"",append_to:i}),r=p({classes:"dropdown-option disabled",append_to:n});r.textContent="Mode",r.dataset.value="";try{if(this.gantt.options.view_modes&&Symbol.iterator in Object(this.gantt.options.view_modes))for(const h of this.gantt.options.view_modes){if(!h||!h.name){console.warn("Invalid view mode:",h);continue}const _=p({tag:"li",classes:"dropdown-option",append_to:n});_.textContent=h.name,_.dataset.value=h.name,h.name===((g=this.gantt.config.view_mode)==null?void 0:g.name)&&(_.classList.add("selected"),t.textContent=h.name),_.addEventListener("click",f=>{f.stopPropagation(),_.dataset.value&&(console.log("Selected view mode:",_.dataset.value),this.gantt.viewManager.change_view_mode(_.dataset.value,!0),this.gantt.reset_play(),this.gantt.scrollManager.set_scroll_position("start"),t.textContent=_.textContent,n.querySelectorAll(".dropdown-option").forEach(w=>w.classList.remove("selected")),_.classList.add("selected"),i.classList.remove("show"),console.log("Dropdown closed after option select"),document.body.contains(this.gantt.$side_header)||(console.log("Side header missing, rebuilding..."),this.gantt.$side_header=null,this.make_side_header()))})}else console.error("view_modes is not iterable or undefined:",this.gantt.options.view_modes)}catch(h){console.error("Error populating dropdown:",h)}console.log("Dropdown options:",Array.from(n.querySelectorAll(".dropdown-option")).map(h=>h.textContent));const o=h=>{h.stopPropagation();const _=i.classList.contains("show");if(i.classList.toggle("show",!_),!_){const f=t.getBoundingClientRect();i.style.position="fixed",i.style.top=`${f.bottom+window.pageYOffset}px`,i.style.left=`${f.left+window.pageXOffset}px`,i.style.minWidth=`${f.width}px`,console.log("Trigger rect:",f)}console.log("Dropdown toggled:",i.classList.contains("show"))};this.gantt.dropdownToggleHandler&&t.removeEventListener("click",this.gantt.dropdownToggleHandler),this.gantt.dropdownToggleHandler=o,t.addEventListener("click",o);const l=h=>{!e.contains(h.target)&&!i.contains(h.target)&&(i.classList.remove("show"),console.log("Dropdown closed via outside click"))};this.gantt.dropdownCloseHandler&&document.removeEventListener("mousedown",this.gantt.dropdownCloseHandler,{capture:!0}),this.gantt.dropdownCloseHandler=l,document.addEventListener("mousedown",l,{capture:!0})}make_grid_ticks(){if(this.gantt.options.lines==="none")return;let e=0,t=this.gantt.config.header_height,i=this.gantt.grid_height-this.gantt.config.header_height,s=m("g",{class:"lines_layer",append_to:this.gantt.layers.grid});const n=this.gantt.dates.length*this.gantt.config.column_width,r=this.gantt.options.bar_height+this.gantt.options.padding;if(this.gantt.options.lines!=="vertical"){let o=this.gantt.config.header_height;for(let l=this.gantt.config.header_height;l<this.gantt.grid_height;l+=r)m("line",{x1:0,y1:o+r,x2:n,y2:o+r,class:"row-line",append_to:s}),o+=r}if(this.gantt.options.lines!=="horizontal")for(let o of this.gantt.dates){let l="tick";this.gantt.config.view_mode.thick_line&&this.gantt.config.view_mode.thick_line(o)&&(l+=" thick"),m("path",{d:`M ${e} ${t} v ${i}`,class:l,append_to:this.gantt.layers.grid}),this.gantt.view_is("month")?e+=d.get_days_in_month(o)*this.gantt.config.column_width/30:this.gantt.view_is("year")?e+=d.get_days_in_year(o)*this.gantt.config.column_width/365:e+=this.gantt.config.column_width}}make_grid_highlights(){this.highlight_holidays(),this.gantt.config.ignored_positions=[];const e=(this.gantt.options.bar_height+this.gantt.options.padding)*this.gantt.tasks.length;this.gantt.layers.grid.innerHTML+=`<pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
        <path d="M-1,1 l2,-2
                 M0,4 l4,-4
                 M3,5 l2,-2"
              style="stroke:grey; stroke-width:0.3" />
    </pattern>`;for(let t=new Date(this.gantt.gantt_start);t<=this.gantt.gantt_end;t.setDate(t.getDate()+1)){if(!this.gantt.config.ignored_dates.find(s=>s.getTime()===t.getTime())&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(t)))continue;let i=d.convert_scales(d.diff(t,this.gantt.gantt_start)+"d",this.gantt.config.unit)/this.gantt.config.step;this.gantt.config.ignored_positions.push(i*this.gantt.config.column_width),m("rect",{x:i*this.gantt.config.column_width,y:this.gantt.config.header_height,width:this.gantt.config.column_width,height:e,class:"ignored-bar",style:"fill: url(#diagonalHatch);",append_to:this.gantt.$svg})}if(this.gantt.options.custom_marker){(!this.gantt.config.custom_marker_date||isNaN(this.gantt.config.custom_marker_date.getTime()))&&(this.gantt.config.custom_marker_date=new Date(this.gantt.options.custom_marker_init_date||this.gantt.gantt_start)),(this.gantt.config.custom_marker_date<this.gantt.gantt_start||this.gantt.config.custom_marker_date>this.gantt.gantt_end)&&(this.gantt.config.custom_marker_date=new Date(this.gantt.gantt_start));const i=d.diff(this.gantt.config.custom_marker_date,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;this.render_animated_highlight(i,this.gantt.config.custom_marker_date),this.gantt.eventQueueManager.initializeEventQueue()}}highlight_holidays(){let e={};if(this.gantt.options.holidays)for(let t in this.gantt.options.holidays){let i=this.gantt.options.holidays[t];i==="weekend"&&(i=n=>n.getDay()===0||n.getDay()===6);let s;if(typeof i=="object"){let n=i.find(r=>typeof r=="function");if(n&&(s=n),i.name){let r=new Date(i.date);i=o=>r.getTime()===o.getTime(),e[r]=i.name}else i=r=>this.gantt.options.holidays[t].filter(o=>typeof o!="function").map(o=>{if(o.name){let l=new Date(o.date);return e[l]=o.name,l.getTime()}return new Date(o).getTime()}).includes(r.getTime())}for(let n=new Date(this.gantt.gantt_start);n<=this.gantt.gantt_end;n.setDate(n.getDate()+1))if(!(this.gantt.config.ignored_dates.find(r=>r.getTime()===n.getTime())||this.gantt.config.ignored_function&&this.gantt.config.ignored_function(n))&&(i(n)||s&&s(n))){const r=d.diff(n,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width,o=this.gantt.grid_height-this.gantt.config.header_height,l=d.format(n,"YYYY-MM-DD",this.gantt.options.language).replace(" ","_");if(e[n]){let c=p({classes:"holiday-label label_"+l,append_to:this.gantt.$extras});c.textContent=e[n]}m("rect",{x:Math.round(r),y:this.gantt.config.header_height,width:this.gantt.config.column_width/d.convert_scales(this.gantt.config.view_mode.step,"day"),height:o,class:"holiday-highlight "+l,style:`fill: ${t};`,append_to:this.gantt.layers.grid})}}}highlight_current(){const e=this.gantt.scrollManager.get_closest_date();if(!e)return null;const[t,i]=e;i.classList.add("current-date-highlight");const s=new Date,r=d.diff(s,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;return this.gantt.$current_highlight=p({top:this.gantt.config.header_height,left:r,height:this.gantt.grid_height-this.gantt.config.header_height,classes:"current-highlight",append_to:this.gantt.$container}),this.gantt.$current_ball_highlight=p({top:this.gantt.config.header_height-6,left:r-2.5,width:6,height:6,classes:"current-ball-highlight",append_to:this.gantt.$header}),{left:r,dateObj:s}}render_animated_highlight(e,t){let i=t||this.gantt.config.custom_marker_date,s=e;!i||isNaN(i.getTime())?(i=new Date(this.gantt.gantt_start),s=0):s=d.diff(i,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let n=this.gantt.grid_height;n||(n=Math.max(this.gantt.config.header_height+this.gantt.options.padding+(this.gantt.options.bar_height+this.gantt.options.padding)*this.gantt.tasks.length-10,this.gantt.options.container_height!=="auto"?this.gantt.options.container_height:0));const r=this.gantt.$svg.querySelector(".grid-background");return r&&(n=parseFloat(r.getAttribute("height"))||n),this.gantt.$animated_highlight?(this.gantt.$animated_highlight.style.left=`${s}px`,this.gantt.$animated_highlight.style.height=`${n-this.gantt.config.header_height}px`,this.gantt.$animated_highlight.offsetHeight):this.gantt.$animated_highlight=p({top:this.gantt.config.header_height,left:s,width:2,height:n-this.gantt.config.header_height,classes:"animated-highlight",append_to:this.gantt.$container,style:"background: var(--g-custom-highlight); z-index: 999;"}),this.gantt.$animated_ball_highlight?(this.gantt.$animated_ball_highlight.style.left=`${s-2}px`,this.gantt.$animated_ball_highlight.offsetHeight):this.gantt.$animated_ball_highlight=p({top:this.gantt.config.header_height-6,left:s-2,width:6,height:6,classes:"animated-ball-highlight",append_to:this.gantt.$header,style:"background: var(--g-custom-highlight); border-radius: 50%; z-index: 1001;"}),{left:s,dateObj:i}}set_dimensions(){const{width:e}=this.gantt.$svg.getBoundingClientRect(),t=this.gantt.$svg.querySelector(".grid .grid-row")?this.gantt.$svg.querySelector(".grid .grid-row").getAttribute("width"):0;e<t&&this.gantt.$svg.setAttribute("width",t)}make_dates(){this.get_dates_to_draw().forEach(e=>{if(e.lower_text){let t=p({left:e.x,top:e.lower_y,classes:"lower-text date_"+k(e.formatted_date),append_to:this.gantt.$lower_header});t.innerText=e.lower_text}if(e.upper_text){let t=p({left:e.x,top:e.upper_y,classes:"upper-text",append_to:this.gantt.$upper_header});t.innerText=e.upper_text}}),this.gantt.upperTexts=Array.from(this.gantt.$container.querySelectorAll(".upper-text"))}get_dates_to_draw(){let e=null;return this.gantt.dates.map((i,s)=>{const n=this.get_date_info(i,e,s);return e=n,n})}get_date_info(e,t,i){let s=t?t.date:null;this.gantt.config.column_width;const n=t?t.x+t.column_width:0;let r=this.gantt.config.view_mode.upper_text,o=this.gantt.config.view_mode.lower_text;return r?typeof r=="string"&&(this.gantt.config.view_mode.upper_text=l=>d.format(l,r,this.gantt.options.language)):this.gantt.config.view_mode.upper_text=()=>"",o?typeof o=="string"&&(this.gantt.config.view_mode.lower_text=l=>d.format(l,o,this.gantt.options.language)):this.gantt.config.view_mode.lower_text=()=>"",{date:e,formatted_date:k(d.format(e,this.gantt.config.date_format,this.gantt.options.language)),column_width:this.gantt.config.column_width,x:n,upper_text:this.gantt.config.view_mode.upper_text(e,s,this.gantt.options.language),lower_text:this.gantt.config.view_mode.lower_text(e,s,this.gantt.options.language),upper_y:25,lower_y:this.gantt.config.header_height-15}}make_bars(){this.gantt.bars=this.gantt.tasks.map(e=>{const t=new Z(this.gantt,e);return this.gantt.layers.bar.appendChild(t.group),t})}make_arrows(){this.gantt.arrows=[];for(let e of this.gantt.tasks){let t=[];t=e.dependencies.map(i=>{const s=this.gantt.get_task(i);if(!s)return null;const n=new U(this.gantt,this.gantt.bars[s._index],this.gantt.bars[e._index]);return this.gantt.layers.arrow.appendChild(n.element),n}).filter(Boolean),this.gantt.arrows=this.gantt.arrows.concat(t)}}}class J{constructor(e){this.gantt=e}bind_events(){this.bind_grid_click(),this.bind_holiday_labels(),this.bind_bar_progress()}bind_grid_click(){u.on(this.gantt.$container,"click",".grid-row, .grid-header, .ignored-bar, .holiday-highlight",()=>{this.gantt.unselect_all(),this.gantt.hide_popup()})}bind_holiday_labels(){const e=this.gantt.$container.querySelectorAll(".holiday-highlight");for(let t of e){const i=this.gantt.$container.querySelector(".label_"+t.classList[1]);if(!i)continue;let s;t.onmouseenter=n=>{s=setTimeout(()=>{i.classList.add("show"),i.style.left=(n.offsetX||n.layerX)+"px",i.style.top=(n.offsetY||n.layerY)+"px"},300)},t.onmouseleave=()=>{clearTimeout(s),i.classList.remove("show")}}}bind_bar_progress(){let e=0,t=!1,i=null,s=null,n=null;u.on(this.gantt.$svg,"mousedown",".handle.progress",(o,l)=>{t=!0,e=o.offsetX||o.layerX,o.offsetY||o.layerY;const g=u.closest(".bar-wrapper",l).getAttribute("data-id");i=this.gantt.get_bar(g),s=i.$bar_progress,n=i.$bar,s.finaldx=0,s.owidth=s.getWidth(),s.min_dx=-s.owidth,s.max_dx=n.getWidth()-s.getWidth()});const r=this.gantt.config.ignored_positions.map(o=>[o,o+this.gantt.config.column_width]);u.on(this.gantt.$svg,"mousemove",o=>{if(!t)return;let l=o.offsetX||o.layerX;if(l>e){let h=r.find(([_,f])=>l>=_&&l<f);for(;h;)l=h[1],h=r.find(([_,f])=>l>=_&&l<f)}else{let h=r.find(([_,f])=>l>_&&l<=f);for(;h;)l=h[0],h=r.find(([_,f])=>l>_&&l<=f)}let g=l-e;g>s.max_dx&&(g=s.max_dx),g<s.min_dx&&(g=s.min_dx),s.setAttribute("width",s.owidth+g),u.attr(i.$handle_progress,"cx",s.getEndX()),s.finaldx=g}),u.on(this.gantt.$svg,"mouseup",()=>{t=!1,s&&s.finaldx&&(s.finaldx=0,i.progress_changed(),i.set_action_completed(),i=null,s=null,n=null)})}get_snap_position(e,t){let i=1;const s=this.gantt.options.snap_at||this.gantt.config.view_mode.snap_at||"1d";if(s!=="unit"){const{duration:g,scale:h}=d.parse_duration(s);i=d.convert_scales(this.gantt.config.view_mode.step,h)/g}const n=e%(this.gantt.config.column_width/i);let r=e-n+(n<this.gantt.config.column_width/i*.5?0:this.gantt.config.column_width/i),o=t+r;const l=r>0?1:-1;let c=this.get_ignored_region(o,l);for(;c.length;)o+=this.gantt.config.column_width*l,c=this.get_ignored_region(o,l),c.length||(o-=this.gantt.config.column_width*l);return o-t}get_ignored_region(e,t=1){return t===1?this.gantt.config.ignored_positions.filter(i=>e>i&&e<=i+this.gantt.config.column_width):this.gantt.config.ignored_positions.filter(i=>e>=i&&e<i+this.gantt.config.column_width)}}class tt{constructor(e){this.gantt=e,this.dependency_map={}}setup_dependencies(){this.dependency_map={};for(let e of this.gantt.tasks)for(let t of e.dependencies)this.dependency_map[t]=this.dependency_map[t]||[],this.dependency_map[t].push(e.id)}get_all_dependent_tasks(e){let t=[],i=[e];for(;i.length;){const s=i.reduce((n,r)=>(n=n.concat(this.dependency_map[r]||[]),n),[]);t=t.concat(s),i=s.filter(n=>!i.includes(n))}return t.filter(Boolean)}}class et{constructor(e){this.gantt=e,this.x_on_scroll_start=0,this.upperTexts=[]}bind_scroll_events(){let e=!1;this.gantt.options.infinite_padding&&u.on(this.gantt.$container,"wheel",t=>{let i=this.gantt.$container.scrollWidth/2;if(!e&&t.currentTarget.scrollLeft<=i){let s=t.currentTarget.scrollLeft;e=!0,this.gantt.gantt_start=d.add(this.gantt.gantt_start,-this.gantt.config.extend_by_units,this.gantt.config.unit),this.gantt.setup_date_values(),this.gantt.render(),t.currentTarget.scrollLeft=s+this.gantt.config.column_width*this.gantt.config.extend_by_units,setTimeout(()=>e=!1,300)}if(!e&&t.currentTarget.scrollWidth-(t.currentTarget.scrollLeft+t.currentTarget.clientWidth)<=i){let s=t.currentTarget.scrollLeft;e=!0,this.gantt.gantt_end=d.add(this.gantt.gantt_end,this.gantt.config.extend_by_units,this.gantt.config.unit),this.gantt.setup_date_values(),this.gantt.render(),t.currentTarget.scrollLeft=s,setTimeout(()=>e=!1,300)}}),this.lastHighlightedMonth=null,u.on(this.gantt.$container,"scroll",t=>{const i=this.gantt.bars.map(({group:g})=>g.getAttribute("data-id"));let s;this.x_on_scroll_start&&(s=t.currentTarget.scrollLeft-this.x_on_scroll_start),this.gantt.current_date=d.add(this.gantt.gantt_start,t.currentTarget.scrollLeft/this.gantt.config.column_width*this.gantt.config.step,this.gantt.config.unit);let n=this.gantt.config.view_mode.upper_text(this.gantt.current_date,null,this.gantt.options.language),r=this.upperTexts.find(g=>g.textContent===n);if(r&&this.lastHighlightedMonth!==n){const g=r.getBoundingClientRect(),h=this.gantt.$container.getBoundingClientRect();g.right<=h.left&&(this.gantt.$current&&this.gantt.$current.classList.remove("current-upper"),r.classList.add("current-upper"),this.gantt.$current=r,this.lastHighlightedMonth=n)}this.x_on_scroll_start=t.currentTarget.scrollLeft;let[o,l,c]=this.gantt.get_start_end_positions();this.x_on_scroll_start>c+100?(this.gantt.$adjust.innerHTML="←",this.gantt.$adjust.classList.remove("hide"),this.gantt.$adjust.onclick=()=>{this.gantt.$container.scrollTo({left:l,behavior:"smooth"})}):this.x_on_scroll_start+t.currentTarget.offsetWidth<o-100?(this.gantt.$adjust.innerHTML="→",this.gantt.$adjust.classList.remove("hide"),this.gantt.$adjust.onclick=()=>{this.gantt.$container.scrollTo({left:o,behavior:"smooth"})}):this.gantt.$adjust.classList.add("hide"),s&&this.gantt.options.auto_move_label&&i.map(h=>this.gantt.get_bar(h)).forEach(h=>{h.update_label_position_on_horizontal_scroll({x:s,sx:t.currentTarget.scrollLeft})})})}set_scroll_position(e){if(this.gantt.options.infinite_padding&&(!e||e==="start")){let[r]=this.gantt.get_start_end_positions();this.gantt.$container.scrollLeft=r;return}if(!e||e==="start")e=this.gantt.gantt_start;else if(e==="end")e=this.gantt.gantt_end;else{if(e==="today")return this.scroll_current();if(e==="custom")return this.scroll_custom_marker();typeof e=="string"&&(e=d.parse(e))}const i=d.diff(e,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;this.gantt.$container.scrollTo({left:i-this.gantt.config.column_width/6,behavior:"smooth"}),this.gantt.$current&&this.gantt.$current.classList.remove("current-upper"),this.gantt.current_date=d.add(this.gantt.gantt_start,this.gantt.$container.scrollLeft/this.gantt.config.column_width,this.gantt.config.unit);let s=this.gantt.config.view_mode.upper_text(this.gantt.current_date,null,this.gantt.options.language),n=this.upperTexts.find(r=>r.textContent===s);this.gantt.current_date=d.add(this.gantt.gantt_start,(this.gantt.$container.scrollLeft+(n?n.clientWidth:0))/this.gantt.config.column_width,this.gantt.config.unit),s=this.gantt.config.view_mode.upper_text(this.gantt.current_date,null,this.gantt.options.language),n=this.upperTexts.find(r=>r.textContent===s),n&&(n.classList.add("current-upper"),this.gantt.$current=n)}scroll_current(){let e=this.get_closest_date();e&&this.set_scroll_position(e[0])}scroll_custom_marker(){const e=this.get_closest_date_to(this.gantt.config.custom_marker_date);e&&this.gantt.config.player_end_date&&e[0]>=this.gantt.config.player_end_date&&this.gantt.eventQueueManager.handle_animation_end()}scroll_to_latest_task(){if(!this.gantt.tasks.length)return;const e=this.gantt.config.custom_marker_date||this.gantt.gantt_start,t=this.gantt.tasks.filter(_=>_._start<=e&&e<=_._end),i=t.length?t.reduce((_,f)=>f._index<_._index?f:_,t[0]):this.gantt.tasks.reduce((_,f)=>f._start<_._start?f:_,this.gantt.tasks[0]),s=this.gantt.$svg.querySelector(`.bar-wrapper[data-id="${i.id}"]`);let n;s?(n=parseFloat(s.getAttribute("y"))||0,n===0&&(n=this.gantt.config.header_height+i._index*(this.gantt.options.bar_height+this.gantt.options.padding))):n=this.gantt.config.header_height+i._index*(this.gantt.options.bar_height+this.gantt.options.padding),this.gantt.eventQueueManager&&(this.gantt.eventQueueManager.lastTaskY=n);const r=n-this.gantt.config.header_height,o=this.gantt.$container.clientHeight,l=this.gantt.options.padding;let c=r-l;const g=this.gantt.$container.scrollHeight-o,h=Math.max(0,Math.min(c,g));this.gantt.$container.scrollTo({top:h,behavior:"smooth"})}start_scroll_animation(e){if(this.gantt.scrollAnimationFrame&&(cancelAnimationFrame(this.gantt.scrollAnimationFrame),this.gantt.scrollAnimationFrame=null),!this.gantt.options.player_state){console.log("start_scroll_animation exited: player_state is false");return}const t=(this.gantt.options.player_interval||1e3)/1e3,i=this.gantt.config.column_width,s=performance.now(),n=this.gantt.$container,r=n.clientWidth,o=n.scrollWidth-r,l=r/6,c=g=>{if(!this.gantt.options.player_state){console.log("animateScroll exited: player_state is false"),this.gantt.scrollAnimationFrame=null;return}const h=(g-s)/1e3,_=Math.min(h/t,1);let w=e+i*_-l;if(w=Math.max(0,Math.min(w,o)),n.scrollLeft=w,this.gantt.tasks.length){const W=this.gantt.config.custom_marker_date,X=this.gantt.tasks.filter(v=>v._start<=W&&W<=v._end);let y;if(X.length){const v=X.reduce((D,L)=>L._index<D._index?L:D,X[0]),M=this.gantt.$svg.querySelector(`.bar-wrapper[data-id="${v.id}"]`);M?(y=parseFloat(M.getAttribute("y"))||0,y===0&&(y=this.gantt.config.header_height+v._index*(this.gantt.options.bar_height+this.gantt.options.padding))):y=this.gantt.config.header_height+v._index*(this.gantt.options.bar_height+this.gantt.options.padding),this.gantt.eventQueueManager&&(this.gantt.eventQueueManager.lastTaskY=y)}else if(this.gantt.eventQueueManager&&this.gantt.eventQueueManager.lastTaskY!==null)y=this.gantt.eventQueueManager.lastTaskY;else{const v=this.gantt.tasks.reduce((D,L)=>L._start<D._start?L:D,this.gantt.tasks[0]),M=this.gantt.$svg.querySelector(`.bar-wrapper[data-id="${v.id}"]`);M?(y=parseFloat(M.getAttribute("y"))||0,y===0&&(y=this.gantt.config.header_height+v._index*(this.gantt.options.bar_height+this.gantt.options.padding))):y=this.gantt.config.header_height+v._index*(this.gantt.options.bar_height+this.gantt.options.padding),this.gantt.eventQueueManager&&(this.gantt.eventQueueManager.lastTaskY=y)}const st=y-this.gantt.config.header_height,nt=n.clientHeight,at=this.gantt.options.padding;let ot=st-at;const rt=n.scrollHeight-nt,ht=Math.max(0,Math.min(ot,rt));n.scrollTop=ht}const F=this.get_closest_date_to(this.gantt.config.custom_marker_date),O=F&&this.gantt.config.player_end_date?F[0]>=this.gantt.config.player_end_date:!1;_<1&&!O?this.gantt.scrollAnimationFrame=requestAnimationFrame(c):(this.gantt.scrollAnimationFrame=null,O&&this.gantt.eventQueueManager.handle_animation_end())};this.gantt.scrollAnimationFrame=requestAnimationFrame(c)}get_closest_date_to(e){let t=e;if(t<this.gantt.gantt_start||t>this.gantt.gantt_end)return null;let i=e,s=this.gantt.$container.querySelector(".date_"+k(d.format(i,this.gantt.config.date_format,this.gantt.options.language))),n=0;for(;!s&&n<this.gantt.config.step;)i=d.add(i,-1,this.gantt.config.unit),s=this.gantt.$container.querySelector(".date_"+k(d.format(i,this.gantt.config.date_format,this.gantt.options.language))),n++;return[new Date(d.format(i,this.gantt.config.date_format,this.gantt.options.language)),s]}get_closest_date(){let e=new Date;if(e<this.gantt.gantt_start||e>this.gantt.gantt_end)return null;let t=new Date,i=this.gantt.$container.querySelector(".date_"+k(d.format(t,this.gantt.config.date_format,this.gantt.options.language))),s=0;for(;!i&&s<this.gantt.config.step;)t=d.add(t,-1,this.gantt.config.unit),i=this.gantt.$container.querySelector(".date_"+k(d.format(t,this.gantt.config.date_format,this.gantt.options.language))),s++;return[new Date(d.format(t,this.gantt.config.date_format,this.gantt.options.language)),i]}setUpperTexts(e){this.upperTexts=e}}class it{constructor(e){this.gantt=e,this.currentViewMode=this.gantt.options.viewMode||"Day"}change_view_mode(e=this.currentViewMode,t=!1){typeof e=="string"&&(console.log("this.gantt.options.view_modes",this.gantt.options.view_modes),e=this.gantt.options.view_modes.find(n=>n.name===e));let i,s;t&&(i=this.gantt.$container.scrollLeft,s=this.gantt.options.scroll_to,this.gantt.options.scroll_to=null),this.gantt.options.view_mode=e.name,this.gantt.config.view_mode=e,this.currentViewMode=e,this.update_view_scale(e),this.setup_dates(t),this.gantt.render(),t&&(this.gantt.$container.scrollLeft=i,this.gantt.options.scroll_to=s),this.gantt.trigger_event("view_change",[e])}update_view_scale(e){let{duration:t,scale:i}=d.parse_duration(e.step);this.gantt.config.step=t,this.gantt.config.unit=i,this.gantt.config.column_width=this.gantt.options.column_width||e.column_width||45,this.gantt.$container.style.setProperty("--gv-column-width",this.gantt.config.column_width+"px"),this.gantt.config.header_height=this.gantt.options.lower_header_height+this.gantt.options.upper_header_height+10}setup_dates(e=!1){this.setup_gantt_dates(e),this.setup_date_values()}setup_gantt_dates(e){let t,i;if(!this.gantt.tasks.length)t=d.today(),i=d.add(d.today(),1,"year");else{console.log("setup_gantt_dates: tasks"),t=this.gantt.tasks[0]._start,i=this.gantt.tasks[0]._end;for(let s of this.gantt.tasks)s._start<t&&(t=s._start),s._end>i&&(i=s._end)}if(t=d.start_of(t,this.gantt.config.unit),i=d.start_of(i,this.gantt.config.unit),this.gantt.options.infinite_padding){const s=d.convert_scales("2d",this.gantt.config.unit),n=this.gantt.config.extend_by_units*3||3;this.gantt.gantt_start=d.add(t,-s,this.gantt.config.unit),this.gantt.gantt_end=d.add(i,n,this.gantt.config.unit)}else{typeof this.gantt.config.view_mode.padding=="string"&&(this.gantt.config.view_mode.padding=[this.gantt.config.view_mode.padding,this.gantt.config.view_mode.padding]);let[s,n]=[{duration:4,scale:"day"},this.gantt.config.view_mode.padding[1]?d.parse_duration(this.gantt.config.view_mode.padding[1]):{duration:1,scale:this.gantt.config.unit}];console.log("setup_gantt_dates: padding:",s,n),this.gantt.gantt_start=d.add(t,-s.duration,s.scale),this.gantt.gantt_end=d.add(i,n.duration,n.scale)}this.gantt.options.view_mode==="Year"?this.gantt.gantt_end=d.add(this.gantt.gantt_end,16,"year"):this.gantt.options.view_mode==="Month"&&(this.gantt.gantt_end=d.add(this.gantt.gantt_end,24,"month")),this.gantt.config.date_format=this.gantt.config.view_mode.date_format||this.gantt.options.date_format,this.gantt.gantt_start.setHours(0,0,0,0),this.gantt.gantt_end.setHours(0,0,0,0)}setup_date_values(){let e=new Date(this.gantt.gantt_start);for(this.gantt.dates=[e];e<this.gantt.gantt_end;)e=d.add(e,this.gantt.config.step,this.gantt.config.unit),this.gantt.dates.push(new Date(e))}}class Q{constructor(e,t,i){this.setup_wrapper(e),this.setup_options(i),this.eventQueueManager=new z(this),this.eventHandler=new J(this),this.taskManager=new tt(this),this.scrollManager=new et(this),this.viewManager=new it(this),this.setup_tasks(t),this.renderer=new K(this),this.viewManager.change_view_mode(),this.eventHandler.bind_events(),this.scrollManager.bind_scroll_events(),this.scrollAnimationFrame=null}setup_wrapper(e){let t,i;if(typeof e=="string"){let s=document.querySelector(e);if(!s)throw new ReferenceError(`CSS selector "${e}" could not be found in DOM`);e=s}if(e instanceof HTMLElement)i=e,t=e.querySelector("svg");else if(e instanceof SVGElement)t=e;else throw new TypeError("Frappe Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");t?(this.$svg=t,this.$svg.classList.add("gantt")):this.$svg=m("svg",{append_to:i,class:"gantt"}),this.$container=p({classes:"gantt-container",append_to:this.$svg.parentElement}),this.$container.appendChild(this.$svg),this.$popup_wrapper=p({classes:"popup-wrapper",append_to:this.$container})}setup_options(e){console.log("setup_options:",e),this.original_options=e,this.options={...G,...e};const t={"grid-height":"container_height","bar-height":"bar_height","lower-header-height":"lower_header_height","upper-header-height":"upper_header_height"};for(let i in t){let s=this.options[t[i]];s!=="auto"&&this.$container.style.setProperty("--gv-"+i,s+"px")}if(this.config={ignored_dates:[],ignored_positions:[],extend_by_units:10},this.options.player_button&&(this.options.player_state=!1),this.options.custom_marker&&(this.config.custom_marker_date=new Date(this.options.custom_marker_init_date)),this.options.player_end_date&&(this.config.player_end_date=new Date(this.options.player_end_date)),typeof this.options.ignore!="function"){typeof this.options.ignore=="string"&&(this.options.ignore=[this.options.ignore]);for(let i of this.options.ignore){if(typeof i=="function"){this.config.ignored_function=i;continue}typeof i=="string"&&(i==="weekend"?this.config.ignored_function=s=>s.getDay()===6||s.getDay()===0:this.config.ignored_dates.push(new Date(i)))}}else this.config.ignored_function=this.options.ignore}update_options(e){this.setup_options({...this.original_options,...e}),this.viewManager.change_view_mode(this.viewManager.currentViewMode,!0),clearInterval(this.player_interval)}setup_tasks(e){this.tasks=e.map((t,i)=>{if(!t.start)return console.error(`task "${t.id}" doesn't have a start date`),!1;if(t._start=d.parse(t.start),t.end===void 0&&t.duration!==void 0&&(t.end=t._start,t.duration.split(" ").forEach(o=>{let{duration:l,scale:c}=d.parse_duration(o);t.end=d.add(t.end,l,c)})),!t.end)return console.error(`task "${t.id}" doesn't have an end date`),!1;if(t._end=d.parse(t.end),d.diff(t._end,t._start,"year")<0)return console.error(`start of task can't be after end of task: in task "${t.id}"`),!1;if(d.diff(t._end,t._start,"year")>10)return console.error(`the duration of task "${t.id}" is too long (above ten years)`),!1;if(t._index=i,d.get_date_values(t._end).slice(3).every(r=>r===0)&&(t._end=d.add(t._end,24,"hour")),typeof t.dependencies=="string"||!t.dependencies){let r=[];t.dependencies&&(r=t.dependencies.split(",").map(o=>o.trim().replaceAll(" ","_")).filter(o=>o)),t.dependencies=r}return t.id?typeof t.id=="string"?t.id=t.id.replaceAll(" ","_"):t.id=`${t.id}`:t.id=I(t),t}).filter(t=>t),this.taskManager.setup_dependencies(),this.scrollManager.scroll_to_latest_task()}refresh(e){this.setup_tasks(e),this.viewManager.change_view_mode(),this.scrollManager.scroll_to_latest_task()}update_task(e,t){let i=this.tasks.find(n=>n.id===e),s=this.bars.find(n=>n.task.id===e);Object.assign(i,t),s.refresh(),this.taskManager.setup_dependencies()}render(){try{if(!this.gantt_start||!this.gantt_end){console.error("Invalid gantt_start or gantt_end",{gantt_start:this.gantt_start,gantt_end:this.gantt_end});return}if(this.config.custom_marker_date||(this.config.custom_marker_date=new Date(this.options.custom_marker_init_date||this.gantt_start)),(this.config.custom_marker_date<this.gantt_start||this.config.custom_marker_date>this.gantt_end)&&(this.config.custom_marker_date=new Date(this.gantt_start)),console.log("render: custom_marker_date=",this.config.custom_marker_date,"gantt_start=",this.gantt_start,"gantt_end=",this.gantt_end,"dates.length=",this.dates.length,"column_width=",this.config.column_width),this.clear(),this.renderer.setup_layers(),this.renderer.make_grid(),this.renderer.make_dates(),this.renderer.make_grid_extras(),this.renderer.make_bars(),this.renderer.make_arrows(),this.map_arrows_on_bars(),this.renderer.set_dimensions(),this.scrollManager.set_scroll_position(this.options.scroll_to),this.scrollManager.setUpperTexts(this.upperTexts),this.options.custom_marker&&this.config.custom_marker_date){const t=d.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;console.log("render: reapplying highlight with left=",t),this.renderer.render_animated_highlight(t,this.config.custom_marker_date)}}catch(e){console.error("Error during render:",e)}}highlight_custom(e){return console.warn("highlight_custom is deprecated; using animated-highlight instead"),this.play_animated_highlight(0,e)}play_animated_highlight(e,t){const{left:i,dateObj:s}=this.renderer.render_animated_highlight(e,t);if(this.options.player_state){let n=(this.options.player_interval||1e3)/1e3,r=this.config.column_width;if(this.config.player_end_date&&s>=this.config.player_end_date)return{left:i,dateObj:s};this.config.player_end_date&&d.add(s,this.config.step,this.config.unit)>this.config.player_end_date&&(n=d.diff(this.config.player_end_date,s,"millisecond")/(this.options.player_interval||1e3),r=d.diff(this.config.player_end_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width-i),[this.$animated_highlight,this.$animated_ball_highlight].forEach(o=>{o.style.setProperty("--animation-duration",`${n}s`),o.style.setProperty("--move-distance",`${r}px`),o.style.animation="none",o.offsetHeight,o.style.animation=`moveRight ${n}s linear forwards`,o.style.animationPlayState="running"})}else[this.$animated_highlight,this.$animated_ball_highlight].forEach(n=>{n.style.animation="none",n.style.animationPlayState="paused"});return{left:i,dateObj:s}}toggle_play(){if(this.config.custom_marker_date||(this.config.custom_marker_date=this.options.custom_marker_init_date||new Date),console.log("toggle_play: custom_marker_date=",this.config.custom_marker_date),this.options.player_state=!this.options.player_state,this.options.player_state){this.options.custom_marker&&this.eventQueueManager.initializeEventQueue(),this.player_interval=setInterval(this.eventQueueManager.player_update.bind(this.eventQueueManager),this.options.player_interval||1e3),this.trigger_event("start",[]),this.eventQueueManager.eventQueue.length>0&&this.eventQueueManager.processEventQueue(!0),this.options.player_use_fa?(this.$player_button.classList.remove("fa-play"),this.$player_button.classList.add("fa-pause")):this.$player_button.textContent="Pause";const t=d.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.play_animated_highlight(t,this.config.custom_marker_date)}else clearInterval(this.player_interval),this.player_interval=null,this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this.trigger_event("pause",[]),this.options.player_use_fa?(this.$player_button.classList.remove("fa-pause"),this.$player_button.classList.add("fa-play")):this.$player_button.textContent="Play",this.$animated_highlight&&(this.$animated_highlight.style.animationPlayState="paused"),this.$animated_ball_highlight&&(this.$animated_ball_highlight.style.animationPlayState="paused")}reset_play(){this.config.custom_marker_date=new Date(this.options.custom_marker_init_date||this.gantt_start),console.log("reset_play: custom_marker_date=",this.config.custom_marker_date),this.options.player_state=!1,this.eventQueueManager.overlapping_tasks.clear(),this.eventQueueManager.lastTaskY=null,this.eventQueueManager.eventQueue=[],clearInterval(this.player_interval),this.player_interval=null,this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this.options.player_use_fa?(this.$player_button.classList.remove("fa-pause"),this.$player_button.classList.add("fa-play")):this.$player_button.textContent="Play",this.render();const t=d.diff(this.config.custom_marker_date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.play_animated_highlight(t,this.config.custom_marker_date),this.trigger_event("reset",[]),this.scrollManager.set_scroll_position("start")}map_arrows_on_bars(){for(let e of this.bars)e.arrows=this.arrows.filter(t=>t.from_task.task.id===e.task.id||t.to_task.task.id===e.task.id)}bind_bar_events(){let e=!1,t=0,i=!1,s=!1,n=null,r=[];this.bar_being_dragged=null;let o=0;const l=()=>e||i||s;u.on(this.$svg,"click",".grid-row",()=>{this.unselect_all()}),u.on(this.$svg,"mousemove",".bar-wrapper, .handle",c=>{this.bar_being_dragged===!1&&Math.abs((c.offsetX||c.layerX)-o)>10&&(this.bar_being_dragged=!0)}),u.on(this.$svg,"mousedown",".bar-wrapper, .handle",(c,g)=>{const h=u.closest(".bar-wrapper",g);g.classList.contains("left")?(i=!0,g.classList.add("visible")):g.classList.contains("right")?(s=!0,g.classList.add("visible")):g.classList.contains("bar-wrapper")&&(e=!0),this.popup&&this.popup.hide(),t=c.offsetX||c.layerX,c.offsetY||c.layerY,n=h.getAttribute("data-id");let _;this.options.move_dependencies?_=[n,...this.taskManager.get_all_dependent_tasks(n)]:_=[n],r=_.map(f=>this.get_bar(f)),this.bar_being_dragged=!1,o=t,r.forEach(f=>{const w=f.$bar;w.ox=w.getX(),w.oy=w.getY(),w.owidth=w.getWidth(),w.finaldx=0})}),u.on(this.$svg,"mousemove",c=>{if(!l())return;const g=(c.offsetX||c.layerX)-t;r.forEach(h=>{const _=h.$bar;_.finaldx=this.eventHandler.get_snap_position(g,_.ox),this.hide_popup(),i?n===h.task.id?h.update_bar_position({x:_.ox+_.finaldx,width:_.owidth-_.finaldx}):h.update_bar_position({x:_.ox+_.finaldx}):s?n===h.task.id&&h.update_bar_position({width:_.owidth+_.finaldx}):e&&!this.options.readonly&&!this.options.readonly_dates&&h.update_bar_position({x:_.ox+_.finaldx})})}),document.addEventListener("mouseup",()=>{e=!1,i=!1,s=!1;const c=this.$container.querySelector(".visible");c&&c.classList.remove("visible")}),u.on(this.$svg,"mouseup",()=>{this.bar_being_dragged=null,r.forEach(c=>{c.$bar.finaldx&&(c.date_changed(),c.compute_progress(),c.set_action_completed())})})}get_start_end_positions(){if(!this.bars.length)return[0,0,0];let{x:e,width:t}=this.bars[0].group.getBBox(),i=e,s=e,n=e+t;for(let{group:r}of this.bars){let{x:o,width:l}=r.getBBox();o<i&&(i=o),o>s&&(s=o),o+l>n&&(n=o+l)}return[i,s,n]}unselect_all(){this.popup&&this.popup.parent.classList.add("hide"),this.$container.querySelectorAll(".date-range-highlight").forEach(e=>e.classList.add("hide"))}view_is(e){return R(this.config.view_mode.name,e)}get_task(e){return this.tasks.find(t=>t.id===e)}get_bar(e){return this.bars.find(t=>t.task.id===e)}show_popup(e){this.options.popup!==!1&&(this.popup||(this.popup=new V(this.$popup_wrapper,this.options.popup,this)),this.popup.show(e))}hide_popup(){this.popup&&this.popup.hide()}trigger_event(e,t){this.options["on_"+e]&&this.options["on_"+e].apply(this,t)}get_oldest_starting_date(){return B(this.tasks)}clear(){this.$svg.innerHTML="",this.$header&&this.$header.remove(),this.$side_header&&this.$side_header.remove(),this.$current_highlight&&this.$current_highlight.remove(),this.$current_ball_highlight&&this.$current_ball_highlight.remove(),this.$extras&&this.$extras.remove(),this.popup&&this.popup.hide(),this.$animated_highlight&&(this.$animated_highlight.remove(),this.$animated_highlight=null),this.$animated_ball_highlight&&(this.$animated_ball_highlight.remove(),this.$animated_ball_highlight=null)}}return Q.VIEW_MODE={HOUR:b[0],QUARTER_DAY:b[1],HALF_DAY:b[2],DAY:b[3],WEEK:b[4],MONTH:b[5],YEAR:b[6]},Q});
